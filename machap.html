<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Machap & Melaka Pinda Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "machap",
                "name": "Machap & Melaka Pinda Estate",
                "reportInfo": "Data based on PA Report (Visit Date: 16th December 2025), Agronomy Report (Visit Date: 26th August 2025) & Audit Report (November 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,014.82 ha",
                            "Mature: 1,014.82 ha",
                            "Immature: 0 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (6 Months FY26 Actual vs Budget)",
                        "value": "13.43 / 10.80 MT",
                        "note": "24% above budget (PA Report)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (6 Months FY26 Actual vs Budget)",
                        "value": "RM 268.59 / RM 318.23",
                        "note": "16% lower than budget (PA Report)"
                    },
                    "ganoderma": {
                        "title": "Ganoderma Status",
                        "value": "High & Increasing",
                        "note": "Major limiting factor (Agronomy)"
                    },
                     "pests": {
                        "title": "Key Pests",
                        "value": "Rats",
                        "note": "Damage >10% in some blocks"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Labour Ratio", "value": "1:11 ha (Adequate)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "P&D Status", "value": "High (Ganoderma)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (YTD)", "value": "19.41%" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Fertilizer Wastage", "value": "High (Needs Attention)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>`, "label": "Harvest Interval", "value": "10-18 days (Acceptable)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-gray-500' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12 12 0 0012 21.644a12 12 0 008.618-15.64z' /></svg>`, "label": "Audit Rating (Nov '25)", "value": "Satisfactory" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["FY 21/22", "FY 22/23", "FY 23/24", "FY 24/25"],
                        "ffb": [19.95, 27.80, 27.45, 27.79],
                        "rainfall": [1500.1, 1546.2, 969.5, 1509.0],
                        "note": "*Historical Annual FFB yield and rainfall. (Source: Previous Reports)"
                    },
                    "ageProfile": {
                        "labels": ["0-3 (Immature)", "4-7 (Young Mature)", "8-19 (Prime)", "20-25 (Old)", ">26 (Old)"],
                        "data": [14, 4, 22, 46, 14],
                        "title": "Palm Age Profile (%)",
                        "note": "*Source: Agronomy Report 1/2025, Pg. 9"
                    }
                },
                "observations": [
                    "<b>Strong Production & Efficiency (PA View):</b> FFB production (13.43 T/ha for 6 months) is 24% above budget, and production cost (RM 268.59/MT) is 16% below budget. Performance is considered satisfactory. <span class='observation-ref'>(PA Pg. 43, 44, 47)</span>",
                    "<b>Ganoderma Infection:</b> This remains the major yield-limiting factor. Replanting is recommended for field MP2003A (30.04 ha) in FY 2026/2027 due to low stand (82 palms/ha). Mounding is in progress. <span class='observation-ref'>(PA Pg. 11, 47; AR Pg. 12, 15)</span>",
                    "<b>Manuring Delays:</b> Manuring progress is delayed due to late delivery of fertilizers by the supplier. October 2025 program (NK Mix & Mix B) was not completed at the time of visit. <span class='observation-ref'>(PA Pg. 26)</span>",
                    "<b>Barn Owl Box Occupancy:</b> Occupancy rate is critically low at 13% (6 out of 44 boxes). Investigation is required to improve this biological control method. <span class='observation-ref'>(PA Pg. 30)</span>",
                    "<b>Fertilizer Wastage (Agronomy):</b> Significant losses occur due to improper application (spreader hitting trunks, runoff into trenches). Immediate correction is needed to prevent wasting inputs. <span class='observation-ref'>(AR Pg. 26-28, 58)</span>",
                    "<b>Harvesting Intervals:</b> Intervals range from 10 to 18 days. While generally acceptable, efforts should be made to keep intervals consistently below 15 days. <span class='observation-ref'>(PA Pg. 39)</span>",
                    "<b>Weighbridge & Stores (Audit):</b> Risks identified in FFB weighing (manual tare entry) and store management (duplicate codes, lubricant measurement). <span class='observation-ref'>(Audit Rpt Pg. 2-8)</span>"
                ],
                "reports": {
                    "agronomy": {
                        "Executive Summary": "The estate's yield has plateaued around 27-28 MT/Ha. Key yield-limiting factors are the high Ganoderma incidence, significant fertilizer wastage from improper application, and harvesting intervals exceeding the 15-day target. While manuring is on schedule and ground vegetation is generally well-controlled, immediate attention is needed to correct fertilizer application techniques and address pest issues (rats). (Source: AR, Pg. 4-7, 60, 66)",
                        "Nutrient Inputs/Progress of Manuring": "The FY 2024/2025 fertilizer program was completed, and the FY 2025/2026 program is on schedule as of July 2025. However, issues persist with wet floors in the fertilizer store and significant wastage during application due to the EMDEK spreader hitting palm trunks and runoff into deep mounding trenches. (Source: AR, Pg. 23-28)",
                        "Agronomic Observation": "Crop recovery needs improvement, with harvesting intervals often exceeding 15 days. Pruning quality is generally satisfactory but with instances of over- and under-pruning. Ganoderma infection is a serious, widespread issue. Rat damage exceeded the 10% threshold in some blocks, requiring baiting. Ground vegetation control is good, but some noxious weeds are present. (Source: AR, Pg. 31, 37, 41, 44, 51)",
                        "Yield Performance": "Yield has stabilized between 27-28 MT/Ha from FY22/23 to FY24/25. The suboptimal palm age profile and a decreasing stand per hectare (from 138 to 127) impact potential. Key limiting factors are Ganoderma, fertilizer wastage, and low rainfall. (Source: AR, Pg. 60-61, 65, 66)",
                        "Fertilizer Recommendation": "No changes are recommended for the existing 2025/2026 fertilizer program. The estate must focus on minimizing the gap between scheduled and actual application and, more importantly, reducing wastage during application. (Source: AR, Pg. 68)"
                    },
                    "plantation": {
                        "Executive Summary": "<b>Performance:</b> Satisfactory. <br><b>Production:</b> 13,631.88 MT (24% above budget). <br><b>Cost:</b> RM 268.59/MT (16% below budget). <br><b>Recommendation:</b> Replanting recommended for Field MP2003A (30.04 ha) in FY 26/27 due to low stand (82/ha). <br><b>Focus:</b> enhance worker skills to boost productivity. (Source: PA, Pg. 47-48)",
                        "Area Statement": "<b>Total Planted (Mature):</b> 1,014.82 ha. <br><b>Immature:</b> 0 ha. <br><b>Other Crops:</b> 5.78 ha (Stevia, Pepper, Durian). <br><b>Pineapple:</b> 13.31 ha on TNB Rentis. <br><b>Replanting Candidate:</b> Field MP2003A (30.04 ha) proposed for FY 26/27. (Source: PA, Pg. 9-11)",
                        "Labour Statement": "<b>Total Force:</b> 97 workers (83 Checkroll, 14 Contract). <br><b>Ratio:</b> 1 worker : 11 ha. <br><b>Harvesters:</b> 53 total (including MTG drivers). Ratio 1:19 ha. <br><b>Contractors:</b> 14 workers covering 194.06 ha. Turnover is high due to tall palms and competition. <br><b>Action:</b> Intensify efforts to retain workers. (Source: PA, Pg. 13-14)",
                        "Staff Establishment": "<b>Manager:</b> Mr. Livindran A/L Ganesan. <br><b>Team:</b> 1 Assistant Manager, 1 Cadet Assistant, 2 Field Supervisors (Harvesting), 1 Trainee (Maintenance). <br><b>Status:</b> Establishment is adequate. (Source: PA, Pg. 12)",
                        "General Charges": "<b>Cost:</b> RM 889.49/ha (Budget: RM 867.38/ha) - 3% Over. <br><b>Key Variances:</b> <ul class='list-disc pl-4'><li>Paid Leave: RM 36k over budget.</li><li>Medical: RM 7k over due to hospitalization.</li><li>Recruitment: High costs incurred.</li></ul> <b>Assessment:</b> Generally acceptable despite overspend. (Source: PA, Pg. 15-16)",
                        "Upkeep Cultivation": "<b>Total Cost:</b> RM 1,007.37/ha (16% below budget). <br><b>Weeding:</b> RM 117.90/ha. Program delayed (31% complete) to accommodate mounding. <br><b>Manuring:</b> RM 573.56/ha. Delayed due to supplier delivery issues (Oct program pending). <br><b>Pests:</b> RM 43.87/ha. Barn Owl occupancy low (13%). <br><b>Roads:</b> RM 62.58/ha. Major grading deferred to Feb-Apr 2026. (Source: PA, Pg. 17-33)",
                        "Harvesting and Collection": "<b>Cost:</b> RM 96.11/MT (1% above budget). <br><b>Infield Loading:</b> High at RM 24.35/MT (46% over) due to MTG breakdowns. <br><b>Intervals:</b> 10-18 days. Oct delays due to assisting Leong Hin San Estate. <br><b>Mechanization:</b> 3 Electric Badang (EV) rented for young mature areas. <br><b>Productivity:</b> 1.5-2.2 MT/manday (Low). Target >3.0 MT. (Source: PA, Pg. 37-41)",
                        "Crop Production": "<b>Total FFB:</b> 13,631.88 MT (6 Months). <br><b>Yield:</b> 13.43 MT/ha (Budget: 10.80 MT/ha). <br><b>OER:</b> 19.41% (Budget: 18.02%). <br><b>KER:</b> 5.08%. <br><b>Assessment:</b> 24% above budget. Highly satisfactory. (Source: PA, Pg. 43)",
                        "Production Cost": "<b>Total Ex-Estate:</b> RM 268.59/MT (Budget: RM 318.23/MT). <br><b>Breakdown:</b> <ul class='list-disc pl-4'><li>General Charges: RM 66.22/MT</li><li>Upkeep: RM 74.99/MT</li><li>Harvesting: RM 127.38/MT</li></ul> <b>Assessment:</b> 16% below budget driven by high yields. (Source: PA, Pg. 44)",
                        "Vehicles Running Cost": "<b>Status:</b> Generally acceptable. <br><b>Issues:</b> <ul class='list-disc pl-4'><li>Tractor WA50FF & VAR9642: Exceeded budget due to repairs.</li><li>MTG: All units show higher costs due to major breakdowns.</li></ul> <b>Fleet:</b> 5 Farm Tractors, 5 MTG (4 active). (Source: PA, Pg. 45-46)",
                        "Capital Expenditure": "N/A",
                        "Immature": "N/A (0 ha). Immature area declared mature Jan 2025. (Source: PA, Pg. 9)"
                    },
                    "pinfosys": "Not Available",
                    "audit": {
                        "Overall Rating": "Satisfactory. (Source: Audit Rpt, Pg. 1)",
                        "FFB Weighing Irregularities": "<b>Finding:</b> Irregularities in FFB weighing procedures at an external weighbridge (Hong Huei). Time-in/out stamps were only seconds apart due to the vendor's manual tare weight entry process. <br><b>Risk:</b> Poses a risk of weight manipulation, though no material variances were found. <br><b>Action:</b> Management will have escorting staff manually record time gaps and attach to weighbridge slips for verification. (Source: Audit Rpt, Pg. 2-5)",
                        "Stores Management Enhancement": "<b>Finding 1 (Stock Categorization):</b> Similar items (e.g., respirators, gloves) have duplicate stock codes in Quarto, causing confusion and count discrepancies. <br><b>Finding 2 (Lubricant Stock Count):</b> Stock counter used an unreliable method of 'shaking the drum' to estimate lubricant balances. <br><b>Action:</b> Management will review/reorganize stock codes and fabricate a calibrated dipstick for accurate lubricant measurement. (Source: Audit Rpt, Pg. 6-9)"
                    }
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Ganoderma Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Gano-01:</b> For areas with >10% infection scheduled for replanting, de-bole all palms by excavating a 1.5m x 1.5m x 1.5m pit at each infected site. Allow 2-3 months of sun exposure before backfilling to suppress inoculum. (AR Pg. 13)</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Gano-02:</b> For palms younger than 20 years with >5% infection, conduct mounding to extend the productive lifespan of affected palms. (AR Pg. 15)</p></div> <div class='policy-item'><p class='font-semibold'>Fertilizer Application</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-08:</b> Cease slant trench cutting for mounding on mineral soils. This practice damages roots and increases risk of fertilizer runoff. Revert to straight trenching with cross-paths to improve machinery access. (AR Pg. 21, 26, 66)</p></div> <div class='policy-item'><p class='font-semibold'>Pest Control (Rats)</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-02a:</b> Following a baiting campaign, a post-baiting census must be conducted to evaluate effectiveness and determine if further action is required. (AR Pg. 52)</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Ganoderma') ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">A monthly Production vs. Rainfall chart cannot be generated as monthly FFB production data is not available in the reports.</p></div>`;
                
                const ageProfileChartHTML = (estate.chartData.ageProfile.data && estate.chartData.ageProfile.data.length > 0) ?
                    `<div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div>` :
                    `<div class="pie-chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">Palm age profile data is not available in the provided reports.</p></div>`;


                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Annual Yield vs Rainfall</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3>${ageProfileChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Internal Audit Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && estateData.chartData.production.labels.length > 0) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Yield (MT/Ha)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Yield (MT/Ha)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#fde047', '#facc15', '#eab308', '#ca8a04', '#a16207'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estateData.chartData.ageProfile.title }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                const auditDiv = document.getElementById(`${estateData.id}-audit`);
                
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (pinfosysDiv && estateData.reports.pinfosys === "Not Available") {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }
                 if (auditDiv && estateData.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estateData.reports.audit).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p classs="text-sm text-gray-600">${content}</p>`).join('');
                } else if (auditDiv) {
                    auditDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
