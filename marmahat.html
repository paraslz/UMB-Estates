<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Marmahat Estate - Plantation, Agronomy & Audit Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const estateData = {
                "id": "marmahat",
                "name": "Marmahat Estate",
                "reportInfo": "Data based on Internal Audit (Oct 2025), PAR (Oct 2025) & Agronomy Report (Jan 2026).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,434.38 ha",
                            "Mature: 686.26 ha",
                            "Immature: 748.12 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (YTD Actual vs Prev)",
                        "value": "15.04 / 10.72 MT",
                        "note": "29% increase vs previous year (AR Pg. 43)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Ex-Estate)",
                        "value": "RM 336.35",
                        "note": "8% below budget (PAR Pg. 45)"
                    },
                    "ganoderma": {
                        "title": "Ganoderma Infection",
                        "value": "59% in P07A34",
                        "note": "Critical infestation detected (AR Pg. 31)"
                    },
                     "manuring": {
                        "title": "Manuring Progress",
                        "value": "Delayed",
                        "note": "Immature prog. behind schedule (AR Pg. 14)"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "P&D Status", "value": "Critical Ganoderma" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Ex-Estate Cost", "value": "RM 336/MT (Good)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "Manuring (Immature)", "value": "Behind Schedule" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' /></svg>`, "label": "Labour Ratio", "value": "1:13 ha (Adequate)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' /></svg>`, "label": "Yield Growth", "value": "+29% vs Prev Period" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-orange-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Fertilizer Store", "value": "Wet/Humid (Critical)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25", "Oct-25", "Nov-25", "Dec-25"],
                        "ffb": [1000, 1050, 1100, 1017, 1000, 1150, 1200, 1300], 
                        "rainfall": [102, 166, 90, 165, 222, 95, 147, 254], 
                        "note": "*FFB/Rainfall based on AR Appendix 3, Pg. 54."
                    },
                    "ageProfile": {
                        "labels": ["Mature (>2022)", "Immature (2022-2023)"],
                        "data": [686.26, 748.12],
                        "title": "Marmahat Estate - Palm Age Distribution (Ha)",
                        "note": "*Source: AR Pg. 8."
                    }
                },
                "observations": [
                    "<b>Severe Ganoderma Infestation:</b> P07A34 shows a critical infection level of 59% (146 fruiting bodies, 61 fallen palms, 426 vacant points). Mounding is underway but deboling activities were notably absent during the visit. <span class='observation-ref'>(AR Pg. 31-32)</span>",
                    "<b>Delayed Manuring (Immature):</b> Manuring for immature areas is slightly behind schedule. Mixture B and Compound fertilizers scheduled for Nov/Dec 2025 were still pending as of late Jan 2026. <span class='observation-ref'>(AR Pg. 14)</span>",
                    "<b>Fertilizer Storage Quality (Critical):</b> The Kamrah Division fertilizer store continues to suffer from wet ground conditions, causing Mixture B bags to harden (off-spec). This issue was highlighted in previous reports but remains unresolved. <span class='observation-ref'>(AR Pg. 15)</span>",
                    "<b>Low Harvester Productivity:</b> Harvesters are averaging below 1.50 MT/day. Inconsistency noted with productivity dropping significantly (e.g., from 3.09 to 0.86 MT/day) for some workers. <span class='observation-ref'>(Audit Pg. 3-4)</span>",
                    "<b>Vegetation and Weed Control:</b> Circle weeding is incomplete in 1999F (11%) and 2007A (70%). Noxious weeds (Clidemia, Melastoma) and VOPs were observed in inter-rows, with Mucuna encroaching palms in P22A07. <span class='observation-ref'>(AR Pg. 25, 37; PAR Pg. 18)</span>",
                    "<b>Yield Disparities:</b> While overall yield increased by 29%, blocks 99F, 01A, and 07A are performing below expectations, averaging only 1.5 MT/month. <span class='observation-ref'>(AR Pg. 43-44)</span>"
                ],
                "reports": {
                    "audit": {
                        "Executive Summary": "Overall internal control systems are rated as Satisfactory. However, specific weaknesses were identified in harvester productivity, harvesting intervals, and field maintenance recording which require immediate management attention. (Source: Audit Pg. 1-2)",
                        "Oil Palm Productivity": "While FFB production shows a surplus against budget, individual harvester productivity is low, averaging below 1.50 MT/day. This led to harvesting intervals exceeding 20 days in July-Sep 2025. Discrepancies were also noted in Quarto Connects usage, with 23% of bunches in July not scanned. (Source: Audit Pg. 2-5)",
                        "Field Maintenance (Premix)": "Inconsistencies were found in premix usage records. Actual gallons paid often exceeded calculated requirements (e.g., usage of 4.9-6.0 Gal/Ha vs expected 3.3-3.5 Gal/Ha). (Source: Audit Pg. 9-14)"
                    },
                    "agronomy": {
                        "Executive Summary": "The visit on 28th Jan 2026 revealed that yield performance for FY25/26 (YTD Dec 2025) is 29% higher than the previous year. However, Ganoderma infection in P07A34 has reached a critical 59%. Manuring progress for immature plantings is behind schedule, and wet conditions in the Kamrah Division fertilizer store persist. (Source: AR Pg. 4, 31, 43)",
                        "Nutrient Inputs/Progress of Manuring": "Mature area manuring is 100% complete. Immature programs for Mix B and Compound fertilizers are 65% complete, with pending blocks originally scheduled for Nov 2025. Fertilizer hardening was observed in Mix B due to storage moisture. (Source: AR Pg. 14-15)",
                        "Agronomic Observation": "<b>Mature Areas:</b> Harvesting intervals improved to 12-16 days by Jan 2026. Canopy management is acceptable, but frond stacking in 99C and 01A is still substandard. VOP presence in 99F remains a concern.<br><b>Immature Areas:</b> Oryctes damage detected in P23C. Palms in P22A04 are recovering from waterlogging. Basal pruning in P22A is incomplete. (Source: AR Pg. 16, 23, 34-35)",
                        "Yield Performance": "As of Dec 2025, yield is 15.04 MT/ha (vs 10.72 MT/ha last year). Block 22A shows promising first-year results. Yield depression noted in 01A-34 and 99F due to Ganoderma. (Source: AR Pg. 43-45)",
                        "Fertilizer Recommendation": "Programs for FY26/27 have been revised. Recommended applications include NK 1, NK 2, and Mix A for mature areas. Sub-soil application recommended for MM07A34 (8.00 kg/palm). (Source: AR Pg. 51-53)"
                    },
                    "plantation": {
                        "Executive Summary": "Performance (May-Sep 2025) improved. FFB production 15% above budget; cost 8% below budget. Labour force adequate (1:12 ha), though reliant on supplementary workers. Weeding and manuring programs are delayed. (Source: PAR Pg. 4-8)",
                        "Area Statement": "Total planted: 1,434.38 ha. Mature: 569.57 ha (following 51.33 ha maturation in Kamrah). Immature: 864.81 ha. (Source: PAR Pg. 10)",
                        "Labour Statement": "116 checkroll workers. Shortage of 42 against requirement (158). Harvesters at 1:13 ha ratio. (Source: PAR Pg. 13-14)",
                        "Staff Establishment": "Satisfactory, though Chief Clerk position is vacant. (Source: PAR Pg. 12)",
                        "General Charges": "RM 471.20/ha (19% below budget). Overspending in Transport/Travel (+19%) due to exec travel. (Source: PAR Pg. 15)",
                        "Upkeep & Cultivation": "Cost RM 1,149.70/ha. Weeding significantly delayed (Circle spraying 21% complete, Interrow 53%). (Source: PAR Pg. 17-29)",
                        "Harvesting and Collection": "RM 144.52/MT. Excluding transport, RM 95.29/MT (10% over budget due to unbudgeted loose fruit collection). (Source: PAR Pg. 39-42)",
                        "Crop Production": "5,167.62 MT (15% above budget). Yield/ha 9.78 MT vs 8.51 budget. OER 19.69%. (Source: PAR Pg. 44)",
                        "Production Cost": "All-in cost RM 433.19/MT. Ex-estate RM 336.35/MT (8% favorable). (Source: PAR Pg. 45)",
                        "Vehicles Running Cost": "Excavator cost RM 18.32/hr (48% above budget). Lorry underutilized and recommended for disposal. (Source: PAR Pg. 46)",
                        "Immature": "P2022A/B cost to maturity RM 20,074/ha. Weeding delayed in 2022B. Sairin LCC effectively suppressing weeds. (Source: PAR Pg. 49-56)"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Ganoderma Management</p><p class='text-sm text-gray-600'><b>Policy Ref: AGRO-GANO-01:</b> Mounding should be paired with deboling to prevent disease spread. Infection levels exceeding 50% in a block require aggressive sanitation.</p></div> <div class='policy-item'><p class='font-semibold'>Fertilizer Storage</p><p class='text-sm text-gray-600'><b>Policy Ref: STORE-FERT-01:</b> Stores must be dry. Humidity/wetness causing caking compromises nutrient availability and worker productivity.</p></div> <div class='policy-item'><p class='font-semibold'>Weeding (Inter-row)</p><p class='text-sm text-gray-600'><b>Policy Ref: AGRO-WEED-03:</b> Selective spraying must target woody weeds. Mucuna must be kept off palm circles to prevent light competition.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Intervals</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-INT-01:</b> Target interval is <15 days. Intervals >20 days result in overripe fruit and quality loss.</p></div>"
            };

            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Analytics Portal`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Ganoderma') ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">FFB Production vs Rainfall</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div></div>
                            <div><h3 class="text-xl font-semibold mb-2">Area Distribution (Ha)</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div></div>
                        </div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3><ul class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul></div>
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Internal Audit Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                
                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', yAxisID: 'y-ffb', tension: 0.4 },
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { 'y-ffb': { position: 'left' }, 'y-rainfall': { position: 'right' } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#059669', '#10b981'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }

            function populateInternalDropdowns() {
                const map = { "audit": "audit", "agronomy": "agronomy", "plantation": "plantation", "pinfosys": "pinfosys" };
                Object.entries(map).forEach(([key, divSuffix]) => {
                    const div = document.getElementById(`${estateData.id}-${divSuffix}`);
                    if (div && estateData.reports[key] !== "Not Available") {
                        div.innerHTML = Object.entries(estateData.reports[key]).map(([s, c]) => `<h4 class="font-bold mt-3 text-gray-800">${s}:</h4><p class="text-sm text-gray-600">${c}</p>`).join('');
                    } else if (div) {
                        div.innerHTML = `<p class="text-sm text-gray-400">Not Available</p>`;
                    }
                });
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const content = document.getElementById(e.currentTarget.dataset.dropdownId);
                        content.classList.toggle('active');
                        e.currentTarget.classList.toggle('active');
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => {
                    document.getElementById('modalContent').innerHTML = estateData.policy;
                    document.getElementById('policyModal').classList.add('active');
                });
            }

            renderEstate();
        });

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
