<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Marmahat Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "marmahat",
                "name": "Marmahat Estate",
                "reportInfo": "Data based on PA Report (May 2025) & Agronomy Report (July 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,434.38 ha",
                            "Mature: 518.24 ha",
                            "Immature: 916.14 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (FY 24/25 Actual vs Budget)",
                        "value": "14.59 / 21.12 MT",
                        "note": "31% below budget (PA Pg. 47)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (FY 24/25 Actual vs Budget)",
                        "value": "RM 590 / RM 416",
                        "note": "42% higher than budget (PA Pg. 48)"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Adequate (Total)",
                        "note": "1:10 ha ratio (PA Pg. 63)"
                    },
                     "pests": {
                        "title": "Pest Status",
                        "value": "Rats & Ganoderma",
                        "note": "Rat damage >20% in C14/C15 (Agro Pg. 34)"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Prod. Cost (Ex-Estate)", "value": "RM 590/MT (High)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Harvest Interval", "value": "20-25 Days (Delayed)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' /></svg>`, "label": "Fertilizer Store", "value": "Wet Conditions" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Weeding Status", "value": "Behind Schedule" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3' /></svg>`, "label": "Yield Trend", "value": "-29% (FY24/25)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Staffing", "value": "Acceptable" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-24", "Jun-24", "Jul-24", "Aug-24", "Sep-24", "Oct-24", "Nov-24", "Dec-24", "Jan-25", "Feb-25", "Mar-25", "Apr-25"],
                        "ffb": [], 
                        "rainfall": [128, 92, 84, 141, 15, 144, 385, 769, 448, 194, 223, 110], // Rainfall data reflects FY24/25 patterns (Agro Appendix 3).
                        "note": "*Monthly FFB data not explicitly tabulated in summary. Rainfall data from Agronomy Report Appendix 3 (FY24/25)."
                    },
                    "ageProfile": {
                        "labels": ["Mature (1999-2007)", "Immature (2022-2024)", "Replanting"],
                        "data": [36, 64, 0], // Derived from Area Statement
                        "title": "Marmahat Estate - Palm Age Distribution",
                        "note": "*Source: Agronomy Report Table 1, Pg. 8."
                    }
                },
                "observations": [
                    "<b>High Production Costs & Low Yield:</b> Production cost has escalated to RM 590/MT, which is 42% above the budget, driven primarily by a low yield of 14.59 MT/ha (31% below budget). <span class='observation-ref'>(PA Pg. 47-48)</span>",
                    "<b>Extended Harvesting Intervals & Crop Loss:</b> Harvesting intervals drifted to 20-25 days between May and July 2025. This has resulted in 5-9% over-ripe bunches and significant loose fruit losses, directly contributing to the yield deficit. <span class='observation-ref'>(Agro Pg. 16-17; PA Pg. 44)</span>",
                    "<b>Critical Fertilizer Storage Conditions:</b> The fertilizer store in Kamrah Division was found in a wet and humid condition, causing fertilizer bags to sweat, harden, and cake. Immediate improvements to store ventilation are required to prevent nutrient degradation. <span class='observation-ref'>(Agro Pg. 14)</span>",
                    "<b>Widespread Weeding Delays:</b> Weeding programs are significantly behind schedule (e.g., Circle spraying only 43% complete). Inter-rows in Blocks P99A and P01A are dominated by broadleaf weeds and woody plants, competing with palms for nutrients. <span class='observation-ref'>(Agro Pg. 27, 30; PA Pg. 24)</span>",
                    "<b>Pest Infestation (Rats & Ganoderma):</b> Rat damage census in blocks C14 and C15 recorded levels above 20%, exceeding the economic threshold. Ganoderma infection is visually significant in P99F-17 and P01A-34, yet no recent census has been conducted. <span class='observation-ref'>(Agro Pg. 34-36)</span>",
                    "<b>Manuring Schedule Delays:</b> While FY24/25 manuring was completed, the FY25/26 program is already delayed by 1-2 months due to supplier delivery issues. Only 3.8% of the Mix A allocated for mature areas had been applied by July 2025. <span class='observation-ref'>(Agro Pg. 12-13)</span>"
                ],
                "reports": {
                    "agronomy": {
                        "Executive Summary": "Yield performance for FY24/25 concluded at 14.60 MT/ha, a significant decline of 29% compared to the previous fiscal year. However, the new financial year (FY25/26) shows promise with a 24% increase in yield year-to-date as of July 2025. The primary challenges identified are the inconsistency in harvesting intervals (extending to 20-25 days), delayed manuring program due to delivery issues, and substandard weeding maintenance. Pests remain a concern with high rat infestation in specific blocks and Ganoderma spreading in mature areas. (Source: AR, Pg. 4-6, 52)",
                        "Nutrient Inputs/Progress of Manuring": "The FY24/25 fertilizer program was 100% completed. However, the FY25/26 program is currently facing delays; as of July 2025, only 3.8% of the Mix A allocated for mature areas has been applied. This delay is attributed to late fertilizer delivery. A critical infrastructure issue was noted at the Kamrah Division fertilizer store, where wet and humid conditions are causing fertilizer bags to sweat and cake, compromising nutrient quality. Immediate improvements to store ventilation are required. (Source: AR, Pg. 12-14)",
                        "Agronomic Observation": "<b>Harvesting:</b> Intervals are irregular, ranging from 9 to 25 days in May-July 2025. This has led to 5-9% overripe bunches and incomplete loose fruit recovery, fostering VOP growth.<br><br><b>Weeding:</b> Circle and inter-row weeding are behind schedule. Blocks P99A-15 and P01A-33 show significant weed competition from Asystasia and woody plants.<br><br><b>Pruning:</b> Generally acceptable, though over-pruning was detected in P22A-05 and P01A-30. Frond stacking in P99C is messy, obstructing paths.<br><br><b>Pests:</b> Rat damage census in C14 and C15 recorded ~20%, exceeding the threshold. Rhinoceros beetle damage in immature areas is being managed with pheromone traps and chemical spraying. (Source: AR, Pg. 16-51)",
                        "Yield Performance": "The estate achieved a yield of 14.60 MT/ha in FY24/25, missing the budget of 21.12 MT/ha and dropping 29% against FY23/24. Block P01A saw the steepest decline (58%). Factors included previous fertilizer withdrawal policies and biological stress. Conversely, early FY25/26 results are positive, with July YTD yield at 6.20 MT/ha, marking a 24% improvement over the same period last year. (Source: AR, Pg. 52-55)",
                        "Fertilizer Recommendation": "For FY25/26, an additional round of NK-1 is recommended for sandy areas in P99F-16 and P99F-17 to boost nutrient uptake. The FY26/27 program has been formulated with a focus on correcting nutrient imbalances. Sub-soil fertilizer application is recommended for P07A due to hardpan soil conditions to minimize surface runoff losses. (Source: AR, Pg. 56-62)"
                    },
                    "plantation": {
                        "Executive Summary": "The estate's performance for the review period (May 2024 - April 2025) was mixed. While the replanting of 494.42 ha in Sairin Division was successfully completed by December 2024, operational challenges persist. The total labour force of 142 workers (1:10 ha) is numerically adequate, but the reliance on supplementary workers for harvesting needs to be addressed. Key financial indicators show a 31% deficit in crop production against budget and a 42% overrun in production costs (RM 590/MT). Immediate focus is needed on normalizing harvesting intervals and expediting weeding programs. (Source: PA, Pg. 4, 63-64)",
                        "Area Statement": "The total planted area stands at 1,426.24 ha (Note: Agronomy report cites 1,434.38 ha). The composition includes 510.10 ha of mature palms, 421.72 ha of immature palms (Kamrah/Awang Pulau), and 494.42 ha of replanting (Sairin). The replanted area in Sairin was completed in Dec 2024 and is transitioning to immature maintenance. (Source: PA, Pg. 10-11)",
                        "Labour Statement": "The estate employs 102 permanent checkroll workers and 40 supplementary workers, totaling 142. This results in a land-to-labour ratio of 1:10 ha. The harvester strength comprises 22 permanent and 7 supplementary workers (29 total), giving a ratio of 1:18 ha. While statistically adequate, the high turnover and lower productivity of supplementary workers necessitate recruiting more permanent harvesters. (Source: PA, Pg. 16-17)",
                        "Staff Establishment": "The staff establishment is stable with a Manager, Senior Assistant Manager, and two Assistant Managers. A new Field Conductor, Muhammad Zulfa, joined in May 2025. The Chief Clerk position remains vacant following a resignation in March 2025. (Source: PA, Pg. 15)",
                        "General Charges": "General Charges expenditure was RM 1,977,727 (RM 1,386.64/ha), which is 2.45% below the budget. However, specific line items exceeded budget: Licenses/Permits (+73%) due to unplanned renewals, Transport & Travelling (+43%), and Staff Bonuses (+32%). Security costs also rose by 17% due to under-budgeted wages. (Source: PA, Pg. 18-20)",
                        "Upkeep and Cultivation": "Total upkeep cost was RM 1,357,233 (RM 2,660.71/ha), exceeding the budget by 22%. Major cost drivers included Manuring (RM 1,204/ha, +40% due to an unbudgeted NK-Mix round) and Soil Conservation (RM 217.95/ha, +308% due to extensive bund repairs and mounding). Weeding costs were also 18% over budget due to heavy broadleaf growth. (Source: PA, Pg. 21, 41)",
                        "Harvesting and Collection": "The cost of harvesting and collection was high at RM 141.87/MT, which is 14% above the budget of RM 124.31/MT. This variance is driven by the low crop base and high fixed costs. Harvester productivity averaged 1.24 - 1.37 MT/man-day. External transport costs to Paitan Mill remain a significant component at RM 49.57/MT. (Source: PA, Pg. 43-46)",
                        "Crop Production": "Total FFB production for the review period was 7,447.12 MT, which is a 31% shortfall against the budget of 10,778 MT. The yield per hectare was 14.59 MT, significantly lower than the budgeted 21.12 MT/ha. The low yield is attributed to the extended harvesting intervals and biological stress on the palms. (Source: PA, Pg. 47)",
                        "Production Cost": "The ex-estate cost of production escalated to RM 590/MT, which is 42% higher than the budget of RM 416/MT. When including depreciation and amortization, the all-in cost is RM 959/MT. The high unit cost is a direct result of the fixed costs being spread over a much lower-than-budgeted crop volume. (Source: PA, Pg. 48)",
                        "Vehicles Running Cost": "Vehicle costs show variance due to utilization levels. The excavator running cost was RM 18.32/hour, 45% above budget due to low utilization hours. Management vehicles are underutilized (RM 3.99-4.46/km). Farm tractors are operating within acceptable cost parameters. The estate is advised to gradually outsource heavy machinery work to reduce overheads. (Source: PA, Pg. 49-50)",
                        "Capital Expenditure": "Specific Capital Expenditure details for infrastructure projects were not tabulated separately in the report summary, though road upkeep and drain construction costs are reflected in the Upkeep section. New drain construction (4ft x 3ft x 2ft) was completed for 5,852 meters at RM 2.20/meter. (Source: PA, Pg. 39)",
                        "Immature": "<b>P2022A (Kamrah, 313.43 ha):</b> Immature harvesting commenced in Feb 2025. Weeding is 48% complete (delayed). Cost to date is RM 19,430/ha.<br><br><b>P2022B (Awang Pulau, 108.29 ha):</b> Should be redesignated as P2023B. Weeding is 47% complete.<br><br><b>P2024C (Sairin, 494.42 ha):</b> Replanting completed Dec 2024. Legume covers are establishing well. Cost to date RM 11,177/ha. (Source: PA, Pg. 51-62)"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Fertilizer Storage</p><p class='text-sm text-gray-600'><b>Policy Ref: STORE-FERT-01:</b> Fertilizer stores must be dry and well-ventilated. Wet conditions compromising fertilizer quality (caking/sweating) are non-compliant.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Intervals</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-INT-02:</b> Harvesting intervals must not exceed 15 days. Intervals of 20-25 days result in loose fruit loss and higher FFA.</p></div> <div class='policy-item'><p class='font-semibold'>Weeding Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: AGRO-WEED-03:</b> Inter-rows must be dominated by soft grasses. Woody weeds (Clidemia, Melastoma) must be eradicated via selective spraying.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Labour') ? 'bg-purple-50 text-purple-800' : 'bg-red-50 text-red-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');
                
                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">A monthly Production vs. Rainfall chart cannot be generated as monthly FFB production data is not available in the reports.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && ((estateData.chartData.production.labels && estateData.chartData.production.labels.length > 0))) {
                    const datasets = [];
                    if (estateData.chartData.production.ffb && estateData.chartData.production.ffb.length > 0) {
                        datasets.push({ label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 });
                    }
                    if (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#a7f3d0', '#fbbf24'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (pinfosysDiv) {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">${estateData.reports.pinfosys}</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
