<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Marmahat Estate - Plantation, Agronomy & Audit Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "marmahat",
                "name": "Marmahat Estate",
                "reportInfo": "Data based on Internal Audit (Oct 2025), PA Report (Oct 2025) & Agronomy Report (July 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,434.38 ha",
                            "Mature: 569.57 ha",
                            "Immature: 864.81 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (Actual vs Budget)",
                        "value": "9.78 / 8.51 MT",
                        "note": "15% above budget (PAR Pg. 44)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Ex-Estate)",
                        "value": "RM 336.35",
                        "note": "8% below budget (PAR Pg. 45)"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Adequate Ratio",
                        "note": "Productivity Issues noted (Audit Pg. 3)"
                    },
                     "audit": {
                        "title": "Audit Rating",
                        "value": "Satisfactory",
                        "note": "Control systems generally satisfactory (Audit Pg. 2)"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Prod. Cost (Ex-Estate)", "value": "RM 336/MT (Good)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Harvest Interval", "value": ">20 Days (High)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' /></svg>`, "label": "Fertilizer Store", "value": "Wet Conditions" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Weeding Status", "value": "Delayed (21% Done)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3' /></svg>`, "label": "Yield Trend", "value": "+19% vs Budget" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Prod.", "value": "<1.5 MT/Day (Low)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25"],
                        "ffb": [1000, 1050, 1100, 1017, 1000], // Estimated distribution based on 5,167 Total
                        "rainfall": [128, 92, 84, 141, 15], 
                        "note": "*Monthly FFB data is illustrative based on total actual production of 5,167 MT (May-Sep)."
                    },
                    "ageProfile": {
                        "labels": ["Mature (>2022)", "Immature (2022-2023)"],
                        "data": [40, 60], // Approx percentage based on 569 ha Mature / 864 ha Immature
                        "title": "Marmahat Estate - Palm Age Distribution",
                        "note": "*Source: PAR Table 1, Pg. 10. Immature area reduced as 51.33 ha declared mature."
                    }
                },
                "observations": [
                    "<b>Low Harvester Productivity (Critical):</b> Harvesters are averaging below 1.50 MT/day. Inconsistency noted with productivity dropping significantly (e.g., from 3.09 to 0.86 MT/day) for some workers. <span class='observation-ref'>(Audit Pg. 3-4)</span>",
                    "<b>Extended Harvesting Intervals:</b> Intervals exceeded 20 days in July, August, and September 2025 due to low harvester productivity, contradicting earlier signs of improvement. <span class='observation-ref'>(Audit Pg. 4)</span>",
                    "<b>Inconsistent Premix Usage:</b> Significant variances found in premix gallons recorded vs. paid (e.g., Block 23C14 paid for 843 gals vs expected ~400 gals). This overstatement directly increases upkeep costs. <span class='observation-ref'>(Audit Pg. 13)</span>",
                    "<b>Quarto System Discrepancies:</b> Discrepancies up to 23% (July 2025) found between FFB bunches captured in Quarto Connects and payable bunches, indicating manual data entry and potential control weaknesses. <span class='observation-ref'>(Audit Pg. 5)</span>",
                    "<b>Critical Fertilizer Storage (Recurring):</b> The Agronomy report noted wet/humid conditions in the Kamrah Division fertilizer store, causing caking. Immediate improvements to store ventilation are required. <span class='observation-ref'>(Agro Pg. 14)</span>",
                    "<b>Weeding Backlog:</b> Circle spraying is only 21% complete against the budget. Interrow blanket spraying is 53% complete. Noxious weeds (Clidemia, Melastoma) remain dominant in some interrows. <span class='observation-ref'>(PAR Pg. 18, 21)</span>",
                    "<b>Manuring Program Delays:</b> The FY25/26 manuring program is behind schedule, with only 36% of the budgeted volume applied by September 2025. <span class='observation-ref'>(PAR Pg. 27)</span>"
                ],
                "reports": {
                    "audit": {
                        "Executive Summary": "Overall internal control systems are rated as Satisfactory. However, specific weaknesses were identified in harvester productivity, harvesting intervals, and field maintenance recording which require immediate management attention. (Source: Audit Pg. 1-2)",
                        "Oil Palm Productivity": "While FFB production shows a 19% surplus against budget (4,207 MT vs 3,538 MT as of Aug 2025), individual harvester productivity is low, averaging below 1.50 MT/day. This has led to harvesting intervals exceeding 20 days in July-Sep 2025. Discrepancies were also noted in Quarto Connects usage, with 23% of bunches in July not scanned at the platform. (Source: Audit Pg. 2-5)",
                        "Field Maintenance (Premix)": "Inconsistencies were found in premix usage records. Actual gallons paid often exceeded calculated requirements (e.g., usage of 4.9-6.0 Gal/Ha vs expected 3.3-3.5 Gal/Ha). Records are not updated promptly, and circle spraying is often combined with roadside spraying without separate recording, leading to cost overstatements. (Source: Audit Pg. 9-14)"
                    },
                    "agronomy": {
                        "Executive Summary": "Yield performance for FY24/25 concluded at 14.60 MT/ha, a significant decline of 29% compared to the previous fiscal year. However, the new financial year (FY25/26) shows promise with a 24% increase in yield year-to-date as of July 2025. The primary challenges identified are the inconsistency in harvesting intervals (extending to 20-25 days), delayed manuring program due to delivery issues, and substandard weeding maintenance. Pests remain a concern with high rat infestation in specific blocks and Ganoderma spreading in mature areas. (Source: AR, Pg. 4-6, 52)",
                        "Nutrient Inputs/Progress of Manuring": "The FY24/25 fertilizer program was 100% completed. However, the FY25/26 program is currently facing delays; as of July 2025, only 3.8% of the Mix A allocated for mature areas has been applied. This delay is attributed to late fertilizer delivery. A critical infrastructure issue was noted at the Kamrah Division fertilizer store, where wet and humid conditions are causing fertilizer bags to sweat and cake, compromising nutrient quality. Immediate improvements to store ventilation are required. (Source: AR, Pg. 12-14)",
                        "Agronomic Observation": "<b>Harvesting:</b> Intervals are irregular, ranging from 9 to 25 days in May-July 2025. This has led to 5-9% overripe bunches and incomplete loose fruit recovery, fostering VOP growth.<br><br><b>Weeding:</b> Circle and inter-row weeding are behind schedule. Blocks P99A-15 and P01A-33 show significant weed competition from Asystasia and woody plants.<br><br><b>Pruning:</b> Generally acceptable, though over-pruning was detected in P22A-05 and P01A-30. Frond stacking in P99C is messy, obstructing paths.<br><br><b>Pests:</b> Rat damage census in C14 and C15 recorded ~20%, exceeding the threshold. Rhinoceros beetle damage in immature areas is being managed with pheromone traps and chemical spraying. (Source: AR, Pg. 16-51)",
                        "Yield Performance": "The estate achieved a yield of 14.60 MT/ha in FY24/25, missing the budget of 21.12 MT/ha and dropping 29% against FY23/24. Block P01A saw the steepest decline (58%). Factors included previous fertilizer withdrawal policies and biological stress. Conversely, early FY25/26 results are positive, with July YTD yield at 6.20 MT/ha, marking a 24% improvement over the same period last year. (Source: AR, Pg. 52-55)",
                        "Fertilizer Recommendation": "For FY25/26, an additional round of NK-1 is recommended for sandy areas in P99F-16 and P99F-17 to boost nutrient uptake. The FY26/27 program has been formulated with a focus on correcting nutrient imbalances. Sub-soil fertilizer application is recommended for P07A due to hardpan soil conditions to minimize surface runoff losses. (Source: AR, Pg. 56-62)"
                    },
                    "plantation": {
                        "Executive Summary": "The estate's performance for the review period (May-Sep 2025) has improved. FFB production is 15% above budget, and production costs are 8% below budget. The labour force is adequate at a 1:12 ha ratio, though there is a reliance on supplementary workers. Weeding and manuring programs are delayed and require immediate attention. The immature area in Kamrah (51.33 ha) was successfully declared mature in May 2025. (Source: PAR, Pg. 4-8)",
                        "Area Statement": "Total planted area stands at 1,434.38 ha. Mature area has increased to 569.57 ha following the maturation of 51.33 ha in Kamrah. Immature area is 864.81 ha. No new replanting is planned for FY 2025/2026. (Source: PAR, Pg. 10)",
                        "Labour Statement": "Total checkroll workers: 116. Shortage of 42 workers against the requirement of 158. Harvesters strength is 45, yielding a ratio of 1:13 ha. The estate needs to recruit more permanent workers to reduce reliance on unstable supplementary labour. (Source: PAR, Pg. 13-14)",
                        "Staff Establishment": "The staff complement is generally acceptable. The position of Chief Clerk is currently vacant and needs to be filled. (Source: PAR, Pg. 12)",
                        "General Charges": "Actual expenditure is RM 471.20/ha, which is 19% below the seasonal budget. However, overspending was noted in Staff EPF (+13%) and Transport & Travelling (+19%) due to high executive travel expenses. (Source: PAR, Pg. 15)",
                        "Upkeep & Cultivation": "Total upkeep cost is RM 1,149.70/ha. Weeding is significantly delayed, with circle spraying is only 21% complete and interrow blanket spraying 53% complete. Manuring is 36% complete, which is behind schedule. (Source: PAR, Pg. 17-29)",
                        "Harvesting and Collection": "The total harvesting cost is RM 144.52/MT. Excluding external transport, the cost is RM 95.29/MT, which is 10% higher than budget due to unbudgeted loose fruit collection (RM 8.61/MT). Harvesting intervals have improved to 10-20 days. (Source: PAR, Pg. 39-42)",
                        "Crop Production": "Actual FFB production to date is 5,167.62 MT, exceeding the budget of 4,496 MT by 15%. Yield per hectare is 9.78 MT, compared to the budgeted 8.51 MT. OER stands at 19.69%. (Source: PAR, Pg. 44)",
                        "Production Cost": "The all-in cost of production is RM 433.19/MT. The ex-estate cost (excluding depreciation/amortization) is RM 336.35/MT, which is 8% favorable against the budget of RM 364.78/MT. (Source: PAR, Pg. 45)",
                        "Vehicles Running Cost": "Generally acceptable. However, excavator running costs (RM 18.32/hr) are 48% above budget. The Mitsubishi Fuso Lorry is underutilized (RM 904/hr) and recommended for disposal. (Source: PAR, Pg. 46)",
                        "Immature Areas": "<b>P2022A/B (370.39 ha):</b> Cost to maturity is RM 20,074/ha. Circle spraying is 90% complete in 2022A but only 18% in 2022B. <br><br><b>Sairin (494.42 ha):</b> Cost to maturity RM 12,039/ha. Palm density is 151/ha. Legume covers are suppressing weeds effectively. (Source: PAR, Pg. 49-56)"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Fertilizer Storage</p><p class='text-sm text-gray-600'><b>Policy Ref: STORE-FERT-01:</b> Fertilizer stores must be dry and well-ventilated. Wet conditions compromising fertilizer quality (caking/sweating) are non-compliant.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Intervals</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-INT-02:</b> Harvesting intervals must not exceed 15 days. Intervals of 20-25 days result in loose fruit loss and higher FFA.</p></div> <div class='policy-item'><p class='font-semibold'>Weeding Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: AGRO-WEED-03:</b> Inter-rows must be dominated by soft grasses. Woody weeds (Clidemia, Melastoma) must be eradicated via selective spraying.</p></div> <div class='policy-item'><p class='font-semibold'>Premix Chemical Recording</p><p class='text-sm text-gray-600'><b>Policy Ref: CHEM-REC-01:</b> Premix usage must be recorded separately for circle spraying and roadside spraying. Records must be reconciled with payment systems monthly.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Labour') ? 'bg-purple-50 text-purple-800' : 
                                       metric.title.includes('Audit') ? 'bg-indigo-50 text-indigo-800' : 'bg-red-50 text-red-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');
                
                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">Chart data not available.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Production Trend (Estimated)</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Internal Audit Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>

                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && ((estateData.chartData.production.labels && estateData.chartData.production.labels.length > 0))) {
                    const datasets = [];
                    if (estateData.chartData.production.ffb && estateData.chartData.production.ffb.length > 0) {
                        datasets.push({ label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 });
                    }
                    if (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#a7f3d0', '#fbbf24'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const auditDiv = document.getElementById(`${estateData.id}-audit`);
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (auditDiv && estateData.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estateData.reports.audit).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (pinfosysDiv) {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">${estateData.reports.pinfosys}</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
