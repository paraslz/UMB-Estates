<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Belida Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        /* Custom styling for list items in report details */
        .report-list li { margin-bottom: 0.5rem; }
        .report-section-title { font-weight: 700; color: #1f2937; margin-top: 1rem; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "belida",
                "name": "Belida Estate (Inti)",
                "reportInfo": "Data based on PA Report (August 2025), Agronomy Report (Nov 2025), and Audit Report (May 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 958.78 ha",
                            "Mature: 955.80 ha",
                            "Immature: 2.98 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (FY 24/25)",
                        "value": "Actual: 28.96 MT vs Budget: 25.86 MT",
                        "note": "12% above budget / +114% vs FY19/20"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (YTD Jul '25)",
                        "value": "RM 365.99 / RM 323.37",
                        "note": "13% higher than budget"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Sufficient",
                        "note": "1:6 ha ratio (Jul '25)"
                    },
                     "pests": {
                        "title": "Pest Status",
                        "value": "High (Rats)",
                        "note": ">5% Damage (Nov '25)"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Ratio", "value": "1:16 ha (Satisfactory)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "P&D Status", "value": "High (Rats, >5%)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (YTD Jul '25)", "value": "19.93%" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-orange-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Weeding Cost", "value": "8% Over Budget (YTD Jul '25)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>`, "label": "Harvest Interval", "value": "<15 Days (Avg)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>`, "label": "Nutrient Status", "value": "Low P, Marginal N" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["Jan-25", "Feb-25", "Mar-25", "Apr-25", "May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25", "Oct-25"],
                        "ffb": [],
                        "rainfall": [452, 302, 345, 335, 146, 40, 92, 143, 312, 155],
                        "note": "*Rainfall data (Jan-Oct 2025) from AR 2/2025. Monthly FFB production data not available."
                    },
                    "ageProfile": {
                        "labels": ["2008 (17 Yrs)", "2012 (13 Yrs)", "2013 (12 Yrs)", "2020 (5 Yrs)", "2023 (2 Yrs)"],
                        "data": [128.82, 775.06, 45.16, 6.76, 2.98],
                        "title": "Belida Estate - Palm Age Distribution (Ha)",
                        "note": "*Source: Agronomy Report 2/2025, Pg. 8."
                    }
                },
                "observations": [
                    "<b>High Rat Infestation:</b> Recent census (Nov 2025) indicates rat damage exceeding the 5% threshold in several blocks (e.g., DG23, DH23, DL23, DK21). A baiting campaign is required urgently starting Dec 2025. <span class='observation-ref'>(AR Pg. 42-43)</span>",
                    "<b>Water Management & Drainage:</b> 27% of the estate (258.76 ha) is flood-prone with high water tables, particularly in peat areas. Drainage maintenance is critical to prevent root submergence and nutrient loss. <span class='observation-ref'>(AR Pg. 27, 59)</span>",
                    "<b>Harvesting Quality Issues:</b> While intervals are acceptable (<15 days), 5-8% overripe bunches were observed in blocks DG15/DG16. Loose fruit collection is inconsistent, with trash and rotten fruits mixed in fertilizer bags. <span class='observation-ref'>(AR Pg. 19-20)</span>",
                    "<b>Agricultural Road Condition:</b> Poor agricultural road conditions remain a critical bottleneck, hindering FFB evacuation and increasing transport costs. <span class='observation-ref'>(PAR Pg. 7, 60)</span>",
                    "<b>Nutrient Deficiencies:</b> Leaf analysis indicates widespread Low P and Marginal N levels. Corrective fertilizer applications (increased P, balanced N) are incorporated into the 2026/2027 program. <span class='observation-ref'>(AR Pg. 34, 48)</span>",
                    "<b>Field Maintenance:</b> Depression in palm circles (DG14) and palms planted in drain lines (DB13) have been rectified, improving vigor. However, localized patches of noxious weeds (Clidemia, Asystasia) persist in 15-20% of blocks. <span class='observation-ref'>(AR Pg. 23, 38)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate's performance has improved and is considered acceptable. The main focus should be on upgrading agricultural road conditions to improve FFB evacuation and enhancing worker productivity through mechanization and training. (Source: PAR, Pg. 9, 88)",
                        "Area Statement": "As of July 2025, the total planted area is 958.78 ha, comprising 955.80 ha mature and 2.98 ha immature palms. The area was revised based on new GIS measurements. (Source: PAR, Pg. 11-12)",
                        "Labour Statement": "The total workforce is 462 workers as of July 2025, resulting in a ratio of 1 worker to 6 ha, which is more than sufficient. The harvester ratio is 1 to 16 ha, which is satisfactory. The estate plans to gradually reduce its workforce by not replacing those who leave. (Source: PAR, Pg. 19-20)",
                        "Staff Establishment": "The staff complement is satisfactory. The Estate Manager was replaced in May 2025. (Source: PAR, Pg. 15)",
                        "General Charges": "The YTD expenditure as of July 2025 is 0.32% over budget, which is satisfactory. For the full financial year 2024/2025, expenditure was 0.58% below budget. (Source: PAR, Pg. 5, 21, 23)",
                        "Upkeep and Cultivation": "YTD July 2025 costs are 72% over budget, driven by accelerated compositing work. Worker productivity in circle weeding is low (1.5-2.0 ha/md) and needs improvement. (Source: PAR, Pg. 5, 28, 52)",
                        "Harvesting and Collection": "Harvester productivity is low (1.1-1.4 MT/md), with income below minimum wage. Total harvesting cost is 2% below budget YTD. Harvesting intervals are well-managed. (Source: PAR, Pg. 8, 70, 72)",
                        "Crop Production": "FY 2024/25 FFB yield was 28.96 MT/ha (12% above budget). YTD July 2025 yield is 6.06 MT/ha (13% above budget). Performance is satisfactory. (Source: PAR, Pg. 8, 74-75)",
                        "Production Cost": "Ex-estate cost for FY 2024/25 was RM 290.30/Tonne (satisfactory). YTD July 2025 cost is 13% higher than the seasonal budget due to higher upkeep costs. (Source: PAR, Pg. 8, 77-78)",
                        "Vehicles Running Cost": "Average vehicle running costs are acceptable, though some mini-tractors show high costs. Internal transport remains necessary due to poor agricultural road conditions. (Source: PAR, Pg. 9, 84)",
                        "Capital Expenditure": "Expenditure is below budget and considered satisfactory. (Source: PAR, Pg. 8, 80)",
                        "Immature": "The 2.98 ha immature area (planted 2023) is in acceptable condition but requires circle spraying. Immature harvesting is scheduled to begin in August 2025. (Source: PAR, Pg. 9, 85)"
                    },
                    "agronomy": {
                        "Executive Summary": "<b>Visit Date:</b> 26th Nov 2025. <br><b>Yield:</b> Achieved 28.96 MT/Ha in FY 24/25, a significant 114% improvement over FY 19/20. <br><b>Key Issues:</b> 27% of the estate (258.76 ha) is flood-prone. Rat damage exceeds 5% threshold in multiple blocks. Nutrient status shows Low P and Marginal N. <br><b>Manuring:</b> 96% completed for FY 25/26 as of Oct 2025. <span class='observation-ref'>(Source: AR, Pg. 4, 7, 44)</span>",
                        "Nutrient Inputs/Progress of Manuring": "<b>Progress (Oct '25):</b> 96% Overall Completion. <br>&bull; Mix B: 100% <br>&bull; RP: 95% (Slight delay) <br>&bull; Kieserite: 100% <br>&bull; MOP: 40% (Ongoing rounds) <br><b>Issues:</b> Lumpy fertilizer application observed (DG14-12B1). Compost application needs better organization; avoid flood-prone areas to reduce Ganoderma risk. <br><b>Constraint:</b> Incomplete fertilizer must NOT be carried forward beyond April 2026. <span class='observation-ref'>(Source: AR, Pg. 11-17)</span>",
                        "Agronomic Observation": "<b>Harvesting:</b> Intervals are good (<15 days). However, 5-8% overripe bunches noted in DG15/DG16. Loose fruit quality varies (trash mixed in). <br><b>Water Management:</b> 258.76 ha (27%) is flood-prone with high water tables, requiring drainage maintenance to prevent root submergence. <br><b>Field Upkeep:</b> Depression in palm circles (DG14) and palms in drain lines (DB13) have been rectified. Weeding has improved; noxious weeds reduced. <br><b>Pests:</b> Nov '25 Census shows rat damage >5% in blocks DG23, DH23, DK21, DL23. Baiting campaign to commence Dec '25. <span class='observation-ref'>(Source: AR, Pg. 18-43)</span>",
                        "Yield Performance": "<b>FY 2024/25:</b> 28.96 MT/Ha (Record High). <br><b>Current YTD (May-Oct '25):</b> 13.19 MT/Ha, marginally higher than previous corresponding period (13.02 MT/Ha). <br><b>Potential:</b> High yield potential as 98.9% of palms are prime age (planted 2008-2012). <br><b>Limiting Factors:</b> Flood-prone peat areas and nutrient lock-up (High C/N ratio). <span class='observation-ref'>(Source: AR, Pg. 44-46)</span>",
                        "Fertilizer Recommendation": "<b>FY 2026/27 Program:</b> Focus on correcting Low P and Marginal N levels (See Appendix 1a). <br><b>Replanting:</b> No manuring for blocks scheduled for replanting in 2026/28. <br><b>New Plantings:</b> Apply 600g CRF + 500g RP in planting holes. <br><b>Application:</b> Avoid application during waterlogged conditions. <span class='observation-ref'>(Source: AR, Pg. 48-50)</span>"
                    },
                    "audit": {
                        "Overall Rating": "Marginally Deficient. The audit found that while most key controls were applied, certain important controls lacked consistency or effectiveness, requiring timely corrective action from management. (Source: Audit Rpt, Pg. 1-2)",
                        "Compost Application Issues": "Audit revealed misleading reporting on compost application, with 2,708 palms unapplied in blocks reported as complete. Payment monitoring was improper, leading to significant overpayments based on delivered weight vs. actual application. (Source: Audit Rpt, Pg. 2-7)",
                        "Field Maintenance Lapses": "A 2.21 ha area in Block DA06-12A2 was not maintained or harvested for over 3 months due to road access being blocked by a neighbor. The issue was not communicated by the Field Conductor to the Estate Manager. (Source: Audit Rpt, Pg. 10-11)",
                        "High Vehicle Repair Costs": "Several Startrac mini-tractor units incurred high and frequent repair costs for parts like rollers and pistons. This was attributed to a lack of dedicated operators for each unit, leading to poor handling and increased wear and tear. (Source: Audit Rpt, Pg. 13-14)"
                    }
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Pest Control (Rats)</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-01:</b> A rat census must be conducted regularly. If fresh damage exceeds 5%, a baiting campaign must be initiated immediately.</p></div> <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer application must adhere to the schedule. Delays due to weather should be mitigated by deploying additional resources once conditions improve.</p></div> <div class='policy-item'><p class='font-semibold'>Pruning & Harvesting</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Harvesting intervals should be maintained between 10-15 days to minimize over-ripe bunches and loose fruit loss.</p><p class='text-sm text-gray-600'><b>Policy Ref: PRUNE-STD-01:</b> Over-pruning is strictly prohibited. Retain at least two subtending fronds for palms under 15 years.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Labour') ? 'bg-purple-50 text-purple-800' : 'bg-red-50 text-red-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-xl font-bold">${metric.value}</p><p class="text-xs text-gray-600 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) || (estate.chartData.production.rainfall && estate.chartData.production.rainfall.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">A monthly Production vs. Rainfall chart cannot be generated as monthly FFB production data is not available in the reports.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Audit Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && ((estateData.chartData.production.labels && estateData.chartData.production.labels.length > 0) || (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0))) {
                    const datasets = [];
                    if (estateData.chartData.production.ffb && estateData.chartData.production.ffb.length > 0) {
                        datasets.push({ label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 });
                    }
                    if (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#059669', '#10b981', '#34d399', '#6ee7b7'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const auditDiv = document.getElementById(`${estateData.id}-audit`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="report-section-title">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-700 leading-relaxed">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="report-section-title">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-700 leading-relaxed">${content}</p>`).join('');
                }
                if (auditDiv && estateData.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estateData.reports.audit).map(([section, content]) => `<h4 class="report-section-title">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-700 leading-relaxed">${content}</p>`).join('');
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
