<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>MLP 3 Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; }
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="text-xl font-bold text-gray-900">
                <a href="index.html" class="flex items-center">
                    MLP 3 Estate Report
                </a>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "mlp3",
                "name": "MLP 3 Estate",
                "reportInfo": "Data based on Plantation Advisory Report (27-28 Oct 2025), Agronomy Report (23 Oct 2025) & Audit Report (May 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,755.70 ha",
                            "Mature: 1,755.70 ha",
                            "Immature: 0.00 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (YTD Actual / Budget)",
                        "value": "10.95 / 10.12 MT",
                        "note": "May-Sep 2025 (PA Report 2/2025)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Actual vs Budget)",
                        "value": "RM 242.41 / RM 268.33",
                        "note": "Ex-Estate (PA Report 2/2025)"
                    },
                    "road": {
                        "title": "Road Upkeep Cost",
                        "value": "RM 323.09/ha",
                        "note": "6% Above Budget (Critical Issue)"
                    },
                     "pests": {
                        "title": "Pest/Disease Status",
                        "value": "Ganoderma Spreading",
                        "note": "Infection spreading (Agronomy Report)"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Ratio", "value": "1:18 ha (Adequate)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Weeding Status", "value": "Delayed (33% vs 75%)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (Actual)", "value": "20.32%" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Road Maint.", "value": "Unsatisfactory" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>`, "label": "Harvest Interval", "value": "10-30 Days (Variable)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Manuring", "value": "Delayed (69% Done)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25", "Oct-25"],
                        "ffb": [], 
                        "rainfall": [445, 308, 309, 309, 94, 178],
                        "note": "*Rainfall data May-Oct 2025. Yield data 10.95 MT/Ha (Actual 5 mths). (Source: PA Report 2/2025, Pg. 40)"
                    },
                    "ageProfile": {
                        "labels": ["Prime Mature (12-18 Yrs)"],
                        "data": [100],
                        "title": "MLP 3 Estate - Palm Age Distribution",
                        "note": "*Source: PA Report 2/2025, Pg. 9."
                    }
                },
                "observations": [
                    "<b>Weeding Program Critical:</b> Significant delays observed. Circle spraying is only 33% complete and selective spraying 26% complete. Interrows are dominated by noxious weeds (Clidemia, Asystasia) and require immediate blanket spraying. <span class='observation-ref'>(PA 2/2025 Pg. 23, 44)</span>",
                    "<b>Road Maintenance Issues:</b> Agricultural roads are unsurfaced and slippery, becoming impassable during rain. This directly impacts FFB evacuation. Cost is RM 323.09/ha (6% over budget). <span class='observation-ref'>(PA 2/2025 Pg. 32, 45)</span>",
                    "<b>Harvesting Delays (Steep Areas):</b> While general intervals are ~15 days, steep areas (e.g., Block 3BB30) are delayed up to 30 days (1 round/month) due to poor access during rain. <span class='observation-ref'>(PA 2/2025 Pg. 37-38)</span>",
                    "<b>Manuring Behind Schedule:</b> The program is only 69% completed. Aug/Sept rounds for Rock Phosphate and Mix B are incomplete due to heavy rain and tractor breakdowns. <span class='observation-ref'>(PA 2/2025 Pg. 27)</span>",
                    "<b>Ganoderma Spreading:</b> Infection has spread from Block A08 to A02, A04, A05, B23, and B24. Sanitation (deboling) is delayed due to machinery limitations. <span class='observation-ref'>(AR 2/2025 Pg. 4, 35)</span>",
                    "<b>Magnesium Deficiency:</b> Localized Magnesium deficiency observed in Block A09. Corrective manuring required. <span class='observation-ref'>(AR 2/2025 Pg. 21)</span>",
                    "<b>Audit - Payroll Compliance:</b> Weaknesses identified in non-payment of sick leave and manipulation of attendance records by field staff. <span class='observation-ref'>(Audit May 2025 Pg. 3-7)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "Overall performance is acceptable. Crop production (19,226.08 MT) is 8% above budget, and ex-estate production cost (RM 242.41/MT) is 10% below budget. However, critical issues persist in field upkeep: agricultural roads are unsurfaced and slippery, hindering access during rain; weeding programs are delayed with interrows dominated by noxious weeds; and manuring is behind schedule. (Source: PA 2/2025, Pg. 7, 44-46)",
                        "Area Statement": "Total planted area remains 1,755.70 ha, comprising entirely of prime mature palms (12-18 years old). The estate is divided into Division A (834.58 ha), Division B (505.72 ha), and Division C (415.40 ha). The terrain is described as steep and hilly, with some areas lacking proper terraces. (Source: PA 2/2025, Pg. 9-11)",
                        "Labour Statement": "Total workforce is 177 against a requirement of 184 (Shortage: -7). Harvester strength is 96 (Ratio 1:18 ha), which is sufficient. Other key categories: Manuring (16 workers), Spraying (22 workers). No special pruning gang is maintained as progressive pruning is practiced. (Source: PA 2/2025, Pg. 14-15)",
                        "Staff Establishment": "Staffing is stable and adequate with a ratio of 1 Field Conductor per 351 ha. The team consists of 1 Senior Assistant Manager (Mr. Tony Tiwon), 1 Assistant Manager, 1 Cadet, 5 Field Conductors, 1 Clerk, and 1 Mechanic. Pn. Augustina is acting as Chief Clerk. (Source: PA 2/2025, Pg. 13)",
                        "General Charges": "Total expenditure is RM 538.88/ha, 17% below the budget of RM 648.93/ha. While overall cost control is good, significant overspending was noted in 'License & Permits' (253% due to calibration costs), 'Entertainment' (184% due to journal entries), and 'General Office Expenses' (56%). (Source: PA 2/2025, Pg. 16-17, 47)",
                        "Upkeep & Cultivation": "Total upkeep cost is RM 1,025.73/ha. <b>Weeding:</b> Delayed (Circle 33%, Selective 26% complete). Interrows are dominated by noxious weeds (Clidemia, Asystasia). <b>Manuring:</b> 69% complete; Aug/Sept rounds delayed by rain. <b>Roads:</b> Cost is RM 323.09/ha (6% over budget); agricultural roads lack crusher run surfacing. <b>Pruning:</b> 21% complete; progressive method used. (Source: PA 2/2025, Pg. 18-35)",
                        "Harvesting and Collection": "Total cost is RM 136/tonne (1% above budget). <b>Intervals:</b> Generally 10-15 days, but steep areas (e.g., 3BB30) lag up to 22-30 days due to rain making paths impassable. <b>Transport:</b> Internal transport cost is high (31% over budget) due to breakdowns. External transport is 14% below budget. Recommendation: Use rubber track vehicles for steep terrain. (Source: PA 2/2025, Pg. 36-39)",
                        "Crop Production": "Actual production (May-Sept) was 19,226.08 MT (10.95 MT/ha), surpassing the budget of 17,771 MT by 8%. OER achieved was 20.32%. High yield is the primary driver for the favorable production cost. (Source: PA 2/2025, Pg. 40)",
                        "Production Cost": "Ex-estate cost is RM 242.41/tonne, 10% lower than the budget of RM 268.33. Breakdown: General Charges RM 49.21/t, Upkeep RM 94.52/t, Harvesting RM 98.68/t. (Source: PA 2/2025, Pg. 41)",
                        "Vehicles Running Cost": "Several vehicles show high running costs, notably Nissan Lorry SAC8935F and Landini Tractor. Unutilized assets (Backhoe SS2248N, Scissor Lift) are recommended for disposal. Strategy is to gradually outsource internal transport to reduce fleet maintenance risks. (Source: PA 2/2025, Pg. 42-43)",
                        "Capital Expenditure": "N/A",
                        "Immature": "N/A (100% Mature Area)"
                    },
                    "agronomy": {
                        "Executive Summary": "Yield performance has improved significantly (12% increase YTD vs last year). Concerns remain regarding incomplete manuring from FY2024/25 and delayed weeding. Magnesium deficiency identified in Block A09 requires corrective action. Ganoderma infection is <1% but spreading; sanitation (deboling) is delayed. (Source: AR 2/2025 Pg. 4-6)",
                        "Nutrient Inputs/Progress of Manuring": "FY2025/2026 program started with 1-3 month delays in some blocks. Application quality is generally acceptable, though some broadcasting was observed too close to terrace lips. Old stock of NK Mix (31.15 MT) requires prioritization. (Source: AR 2/2025 Pg. 10-13)",
                        "Agronomic Observation": "<b>Harvesting:</b> Intervals improved to ~15 days. Delays in hilly blocks (09B, 10B) due to accessibility. <br><b>Vegetation:</b> Inter-row spraying significantly delayed. Undesirable weeds like Clidemia hirta present. <br><b>Pest & Disease:</b> Ganoderma spreading (49 dead palms). Deboling delayed. Rat damage minor. <br><b>Nutrient Status:</b> Magnesium deficiency confirmed in Block A09. (Source: AR 2/2025 Pg. 14-36)",
                        "Yield Performance": "Yield of 13.24 MT/Ha (YTD Oct 2025), a 12% increase vs same period last year. Block 11B showed highest improvement (16%). Road maintenance in rehab blocks (B22) critical for crop evacuation. (Source: AR 2/2025 Pg. 37-38)",
                        "Fertilizer Recommendation": "FY2025/2026 program unchanged. FY2026/2027 draft attached. Sub-soil application to be continued in Blocks A01, A05, 30, and 31. (Source: AR 2/2025 Pg. 39)"
                    },
                    "pinfosys": {
                        "CEO Financial Summary": "N/A",
                        "Summary of Oil Palm Expenditure": "N/A"
                    },
                    "audit": {
                        "Overall Rating": "Marginally Deficient. While most key controls are applied, some important controls lack consistency or effectiveness. (Source: Audit May 2025 Pg. 2)",
                        "Payroll and Personnel": "Weaknesses identified: <br>1. Non-payment of entitled paid sick leave. <br>2. Irregular attendance entries (photos vs live biometric). (Source: Audit May 2025 Pg. 3-5)",
                        "Oil Palm Operations": "Enhancements needed for FFB transport: <br>1. Discrepancies in 'Time Out' and 'Mill Time In'. <br>2. Use of unregistered lorries. <br>3. Significant FFB backlog due to poor road conditions. (Source: Audit May 2025 Pg. 8-14)",
                        "Manuring": "FY 24/25 manuring in rehabilitation Block 3CC42 was incomplete/delayed due to accessibility. (Source: Audit May 2025 Pg. 20-21)"
                    }
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Ganoderma Control</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Gano-01:</b> For infected palms, immediate sanitation via deboling (1.5m x 1.5m x 1.5m pit) is required to prevent spread.</p></div> <div class='policy-item'><p class='font-semibold'>Nutrient Management</p><p class='text-sm text-gray-600'><b>Policy Ref: SOIL-MG-01:</b> Correct Magnesium deficiency through Kieserite application or specific fertilizer mix as per Agronomist recommendation.</p></div> <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer application must strictly adhere to the schedule. Broadcasting must be done at the edge of the weeded circle, not on terrace lips.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Maintain harvesting intervals below 15 days. In hilly terrain, ensure road maintenance to prevent skipped rounds.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Manuring') ? 'bg-yellow-50 text-yellow-800' : 
                                       metric.title.includes('Pest') || metric.title.includes('Road') ? 'bg-red-50 text-red-800' : 'bg-gray-50 text-gray-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                // Check if we have data to show the chart
                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">Chart data unavailable.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Rainfall Analysis (May - Oct 2025)</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-800 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-green-900 text-white p-3 rounded-md hover:bg-green-800 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-green-900 text-white p-3 rounded-md hover:bg-green-800 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-green-900 text-white p-3 rounded-md hover:bg-green-800 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-green-900 text-white p-3 rounded-md hover:bg-green-800 transition">Audit Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && estateData.chartData.production.labels && estateData.chartData.production.labels.length > 0) {
                    const datasets = [];
                    // Only adding rainfall as FFB monthly data wasn't explicitly provided in the PDF summary table snippet
                    if (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                x: { grid: { display: false } }, 
                                'y-rainfall': { type: 'linear', position: 'left', title: { display: true, text: 'Rainfall (mm)' } } 
                            } 
                        }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#34d399', '#a7f3d0'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                const auditDiv = document.getElementById(`${estateData.id}-audit`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (pinfosysDiv && estateData.reports.pinfosys) {
                    if (typeof estateData.reports.pinfosys === 'string') {
                         pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">${estateData.reports.pinfosys}</p>`;
                    } else {
                        pinfosysDiv.innerHTML = Object.entries(estateData.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                    }
                }
                 if (auditDiv && estateData.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estateData.reports.audit).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
