<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Arwana Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "arwana",
                "name": "Arwana Estate (Inti)",
                "reportInfo": "Data based on PA Report (Feb 2025) & Agronomy Report (Apr 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,433.90 ha",
                            "Mature: 908.61 ha",
                            "Immature: 525.29 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (YTD vs Budget)",
                        "value": "5.55 / 8.40 MT",
                        "note": "34% below budget"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (YTD vs Budget)",
                        "value": "RM 680 / RM 503",
                        "note": "35% higher than budget"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Adequate",
                        "note": "1:6 ha ratio"
                    },
                     "pests": {
                        "title": "Pest Status",
                        "value": "Low (Rats)",
                        "note": "Damage at 2.5%"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Ratio", "value": "1:22 ha (Adequate)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "P&D Status", "value": "Low (Rats at 2.5%)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (YTD)", "value": "18.89%" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Prod.", "value": "0.8 MT/md (Very Low)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>`, "label": "Harvest Interval", "value": "9 days (Too short)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-teal-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>`, "label": "Rehabilitation", "value": "150 ha pending" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["2018/19", "2019/20", "2020/21", "2021/22", "2022/23", "2023/24"],
                        "ffb": [1.13, 1.17, 2.99, 4.20, 5.72, 9.61],
                        "rainfall": [], // No rainfall data available for this chart
                        "note": "*FFB Performance from FY 2018/19 to 2023/24. (Source: AR Pg. 64)"
                    },
                    "ageProfile": {
                        "labels": ["Young Mature (4-7 Yrs)", "Prime Mature (8-19 Yrs)", "Immature (<4 Yrs)"],
                        "data": [62.3, 28.1, 9.6],
                        "title": "Arwana Estate - Palm Age Distribution",
                        "note": "*Source: Agronomy Report 1/2025, Pg. 10."
                    }
                },
                "observations": [
                    "<b>Very Low Harvester Productivity:</b> Productivity averages only 0.8 MT/man-day, with many harvesters not earning basic wage. This is a critical issue affecting production. <span class='observation-ref'>(PAR Pg. 57, 60)</span>",
                    "<b>Unsatisfactory Ground Vegetation:</b> Field vegetation is unsatisfactory, with overgrown interrows and improper circle spraying. This increases competition for nutrients and hinders operations. <span class='observation-ref'>(AR Pg. 49, 53)</span>",
                    "<b>Incomplete Manuring Program:</b> The manuring program for FY2024/25 is only 40% complete as of April 2025, continuing a trend of shortfalls from previous years. This severely impacts palm health and yield. <span class='observation-ref'>(AR Pg. 17)</span>",
                    "<b>Low Palm Density:</b> Average stand is only 117 palms/ha, with many blocks having densities below 100. This is a major yield-limiting factor requiring an aggressive supplying program. <span class='observation-ref'>(AR Pg. 11-12)</span>",
                    "<b>Significant Crop Losses:</b> Poor crop recovery was observed, with rotten/overripe bunches left on palms and on the ground, indicating significant yield loss. <span class='observation-ref'>(AR Pg. 27, 31-36)</span>",
                    "<b>High Production Cost:</b> Cost per tonne is high at RM 680, driven by low production and over-budget upkeep costs. <span class='observation-ref'>(PAR Pg. 63)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "Field conditions at regular blocks are satisfactory, but rehabilitated blocks require significant focus on weeding. Chemical usage and recording must be improved. Completing manuring programs and upgrading roads are crucial to boost bunch weights and production. (Source: PAR, Pg. 68-69)",
                        "Area Statement": "Mature area is 908.61 ha and immature is 525.29 ha. 150 ha of rehabilitation is scheduled for FY 2025/26. (Source: PAR, Pg. 10, 16)",
                        "Labour Statement": "The worker ratio of 1:6 ha is too high (too many workers), leading to low average wages. The estate should aim for a 1:10 ratio by increasing productivity. (Source: PAR, Pg. 17-18)",
                        "Staff Establishment": "Staffing is adequate with no changes during the review period. (Source: PAR, Pg. 19)",
                        "General Charges": "Underspent by 28% YTD. Overspending on security and office equipment was due to unbudgeted but necessary expenses. (Source: PAR, Pg. 20-22)",
                        "Upkeep Cultivation": "Overspent by 4% due to under-budgeted rehabilitation works. Weeding practices are inefficient, with low productivity and inaccurate chemical recording. (Source: PAR, Pg. 23-29)",
                        "Harvesting and Collection": "Harvester productivity is very low (avg. 0.8 MT/md), and earnings are below basic wage. Harvesting interval of 9 days is too short. Mechanized infield collection is planned for May 2025. (Source: PAR, Pg. 56-57)",
                        "Crop Production": "YTD yield is 5.55 MT/ha, 34% below budget due to low productivity, low bunch weights, and issues in rehabilitated areas. (Source: PAR, Pg. 60)",
                        "Production Cost": "High production cost of RM 680/tonne is due to low crop production. (Source: PAR, Pg. 63)",
                        "Vehicles Running Cost": "Vehicle running costs are well-controlled, with utilization at 85%. (Source: PAR, Pg. 64)",
                        "Capital Expenditure": "Capital expenditure was underspent. (Source: PAR, Pg. 65)",
                        "Immature": "2024 plantings are progressing. Some areas show weedy conditions. (Source: PAR, Pg. 66)"
                    },
                    "agronomy": {
                        "Executive Summary": "Yields remain far below expectations despite some improvement. Suboptimal agronomic conditions, including poor crop recovery and unsatisfactory weeding, are major limiting factors. (Source: AR, Pg. 4-6)",
                        "Nutrient inputs progress of manuring": "Manuring has been consistently incomplete for years. The FY2024/25 program is only 40% complete as of April 2025, hindered by late deliveries and flooding. (Source: AR, Pg. 17-18)",
                        "Agronomic observation": "Crop recovery is unsatisfactory with significant losses. Pruning standards are inconsistent. Palm appearance is poor in rehab areas. Ground vegetation control is unsatisfactory. (Source: AR, Pg. 25, 38, 45, 49)",
                        "Yield performance": "Yield increased by 16.8% in FY2024/25 to 7.62 MT/ha (May-Mar) but is still very low. Incomplete crop recovery is a primary cause. (Source: AR, Pg. 65)",
                        "Fertilizer recommendation": "The FY2025/26 fertilizer program has been revised to account for delays, reducing application rounds from four to three for several plantings. (Source: AR, Pg. 70, 72-73)"
                    }
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Pest Control (Rats)</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Rat-01:</b> A rat census must be conducted quarterly. If fresh damage exceeds 10%, a baiting campaign must be initiated immediately.</p></div> <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer application must adhere to the schedule. Delays due to weather should be mitigated by deploying additional resources once conditions improve.</p></div> <div class='policy-item'><p class='font-semibold'>Pruning & Harvesting</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Harvesting intervals should be maintained between 10-15 days to minimize over-ripe bunches and loose fruit loss.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Labour') ? 'bg-purple-50 text-purple-800' : 'bg-red-50 text-red-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">FFB Yield Performance (MT/Ha)</h3><div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <!-- Key Observations & AI Action Plan -->
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg mb-8">
                            <h3 class="text-xl font-semibold mb-2 text-green-900">âœ¨ AI-Powered Action Plan</h3>
                            <p class="text-green-800 mb-4">Click the button to generate a strategic action plan based on the key observations above.</p>
                            <div class="text-center">
                                <button id="generate-plan-btn" class="bg-green-700 text-white px-6 py-3 rounded-lg hover:bg-green-800 transition shadow-md flex items-center justify-center mx-auto">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>
                                    Generate Action Plan
                                </button>
                            </div>
                            <div id="action-plan-container" class="mt-4"></div>
                        </div>

                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'FFB Yield (MT/Ha)', data: estateData.chartData.production.ffb, backgroundColor: '#16a34a' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, y: { title: { display: true, text: 'FFB (MT/Ha)' } } }, plugins: { legend: { display: false } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#34d399', '#a7f3d0'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
                document.getElementById('generate-plan-btn')?.addEventListener('click', generateActionPlan);
            }
            
            async function generateActionPlan() {
                const container = document.getElementById('action-plan-container');
                container.innerHTML = '<div class="loader"></div>';

                const observationsList = document.getElementById('observations-list');
                const issues = Array.from(observationsList.getElementsByTagName('li')).map(li => li.innerText).join('\n');
                
                const prompt = `Based on the following key observations and issues from a plantation estate report, act as an experienced plantation management consultant. Provide a prioritized, actionable plan for the estate manager. For each issue, suggest specific, practical steps to address it. Format the response in clear sections with bold headings and bullet points for the action items. Here are the issues:\n\n${issues}`;

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    
                    let text = 'No response from AI.';
                    if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        text = result.candidates[0].content.parts[0].text;
                    }
                    
                    // Basic Markdown to HTML conversion
                    let html = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                        .replace(/\n/g, '<br>') // Newlines
                        .replace(/(\*|-)\s(.*?)(<br>|$)/g, '<li class="ml-4 list-disc">$2</li>'); // Bullets
                    
                    container.innerHTML = `<div class="prose max-w-none text-gray-700">${html}</div>`;

                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    container.innerHTML = `<p class="text-red-500">Failed to generate action plan. Please try again. Error: ${error.message}</p>`;
                }
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
