<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>MLP 1 Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "mlp1",
                "name": "MLP 1 Estate",
                "reportInfo": "Data based on Planting Advisory Report (October 2025) & Agronomy Report (September 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,607.14 ha",
                            "Mature: 1,607.14 ha",
                            "Immature: 0 ha",
                            "Rehabilitation: 118.93 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (Actual vs Budget)",
                        "value": "8.95 / 8.43 MT",
                        "note": "YTD Sep 2025 (6% Above Budget)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Actual vs Budget)",
                        "value": "RM 296.04 / RM 346.10",
                        "note": "YTD Sep 2025 (Ex-Estate)"
                    },
                    "weeding": {
                        "title": "Weeding Status",
                        "value": "Unsatisfactory",
                        "note": "Inter-row spraying delayed"
                    },
                     "manuring": {
                        "title": "Manuring Progress",
                        "value": "Delayed",
                        "note": "73% Completed vs Budget"
                    }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Ratio", "value": "1:14 ha (Adequate)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "P&D Status", "value": "Under Control" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' /></svg>", "label": "Yield Trend", "value": "+27% vs Last Year" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Weeding Quality", "value": "Unsatisfactory" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>", "label": "Harvest Interval", "value": "14 days (Acceptable)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>", "label": "Road Condition", "value": "Deep Ruts Observed" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-25", "Jun-25", "Jul-25", "Aug-25", "Sep-25"],
                        "ffb": [],
                        "rainfall": [],
                        "note": "*Detailed monthly breakdown not provided in advisory summary."
                    },
                    "ageProfile": {
                        "labels": ["2004 Planting", "2005 Planting", "2006 Planting", "2007 & 2011 Planting"],
                        "data": [579.94, 426.46, 351.8, 248.94],
                        "title": "MLP 1 Estate - Palm Age Distribution (Ha)",
                        "note": "*Source: Agronomy Report 2/2025, Pg. 8-9."
                    }
                },
                "observations": [
                    "<b>Unsatisfactory Weed Management:</b> Inter-row conditions are unsatisfactory with prevalent woodies, wild bananas, and bamboo. The estate is currently short of 6 sprayers, contributing to this backlog. <span class='observation-ref'>(PA Report 2/2025, Pg. 5, 33, 84)</span>",
                    "<b>Harvesting Productivity & Loose Fruit:</b> While harvester numbers are adequate, individual productivity is low. Uncollected old loose fruits were found in rehabilitation blocks, and fresh loose fruits were missed in other areas. <span class='observation-ref'>(PA Report 2/2025, Pg. 63, 65; Agronomy Report Sep 2025, Pg. 17)</span>",
                    "<b>Manuring Delays & Application Issues:</b> Only 73% of the budgeted area was manured by September 2025 due to fertilizer delivery delays (Mix B). Sub-surface application productivity is low (0.4 ha/manday vs target 1.0 ha). <span class='observation-ref'>(PA Report 2/2025, Pg. 49; Agronomy Report Sep 2025, Pg. 13)</span>",
                    "<b>Road Maintenance:</b> While improved, agricultural collection roads still exhibit deep ruts. High costs were noted for road surfacing material (RM 1207/chain). Immediate grading and repair are required. <span class='observation-ref'>(PA Report 2/2025, Pg. 57, 84)</span>",
                    "<b>Rehabilitation Progress:</b> 118.93 ha require corrective pruning. As of September, 91.93 ha had been completed. Old loose fruits in these areas must be collected and burned to prevent VOPs. <span class='observation-ref'>(PA Report 2/2025, Pg. 10, 53)</span>",
                    "<b>Nutrient Deficiencies:</b> Magnesium deficiency symptoms persist in hilly and steep terrain areas, likely due to leaching or missed applications. <span class='observation-ref'>(Agronomy Report Sep 2025, Pg. 20)</span>"
                ],
                "reports": {
                    "agronomy": {
                        "Executive Summary": "Yield performance has improved significantly in the current financial year (FY2025/2026) compared to the last. However, key yield-limiting factors persist, including delays in manuring and weeding, inconsistent harvesting intervals, and incomplete loose fruit collection. Palm nutrient status is generally acceptable, though some deficiencies are noted in hilly areas. (Source: AR, Pg. 4-5, 40-41)",
                        "Nutrient Inputs/Progress of Manuring": "The FY2024/2025 manuring program was not fully completed due to land disputes and rehabilitation work. The current FY2025/2026 program is experiencing delays of up to 2 months. Application quality is generally acceptable, but fertilizer should not be applied in weedy circles. (Source: AR, Pg. 11-13)",
                        "Agronomic Observation": "Harvesting intervals are inconsistent, ranging from 10-20 days, though improving. Loose fruit collection needs more attention. Palm appearance is generally good, but Magnesium deficiency is visible in some blocks. Canopy management is acceptable, but corrective pruning (55% complete) and frond stacking require improvement. Weeding is delayed, especially in inter-rows. Pest and disease are under control. (Source: AR, Pg. 15, 17, 20, 24, 28, 31, 39)",
                        "Yield Performance": "Overall yield for FY2024/2025 increased by 2% from the previous year. As of August 2025 (Period 4 of FY2025/2026), the estate's yield has increased by 19% compared to the same period last year. This positive trend is driven by improved crop recovery, though it is still hampered by weeding delays and ongoing rehabilitation. (Source: AR, Pg. 40-42)",
                        "Fertilizer Recommendation": "The fertilizer program for FY2025/2026 remains unchanged. The program for FY2026/2027 has been prepared, with sub-soil application proposed for steep terrain to improve nutrient uptake. (Source: AR, Pg. 44)"
                    },
                    "plantation": {
                        "Executive Summary": "Crop production is encouraging (6% above budget YTD Sept 2025). However, weed management is a continuous issue with inter-row conditions unsatisfactory. Harvester productivity needs improvement to justify wages. (Source: PA 2/2025, Pg. 84-85)",
                        "Area Statement": "Total planted area is 1,607.14 ha (Mature). No immature area. 118.93 ha is under rehabilitation (corrective pruning). 2.00 ha planted with coffee. (Source: PA 2/2025, Pg. 9-10)",
                        "Labour Statement": "Total workforce is 220 vs requirement of 231. Harvesters are adequate (112), but there is a critical shortage of 6 sprayers (10 available vs 16 required). (Source: PA 2/2025, Pg. 13-14)",
                        "Staff Establishment": "Staff establishment is satisfactory with no changes. (Source: PA 2/2025, Pg. 15-16)",
                        "General Charges": "Underspent by 6% as of September 2025. Overspending noted in General Office Expenses due to Agronomist fees and Printing/Stationery. (Source: PA 2/2025, Pg. 19-22)",
                        "Upkeep & Cultivation": "Underspent by 26% YTD September. Circle spraying is satisfactory, but inter-row spraying is unsatisfactory with missed woodies. Manuring is 73% complete; delays caused by fertilizer supply. (Source: PA 2/2025, Pg. 24-33)",
                        "Harvesting and Collection": "Harvesting interval is 14 days. Harvester productivity is low. High supervision costs due to mandore incentives. Loose fruit collection rates RM 3.75/bag. (Source: PA 2/2025, Pg. 61-65)",
                        "Crop Production": "YTD Sept 2025 Production: 14,385.57 MT (6% above budget). Yield per ha: 8.95 MT (Budget: 8.43 MT). This is 27% higher than the same period last year. (Source: PA 2/2025, Pg. 66-67)",
                        "Production Cost": "Ex-estate cost is RM 296.04/MT, which is below the budget of RM 346.10/MT due to higher production. (Source: PA 2/2025, Pg. 68)",
                        "Vehicles Running Cost": "Generally in line with budget. High repair costs noted for tractors, bulldozers, and motor graders. (Source: PA 2/2025, Pg. 73-78)",
                        "Capital Expenditure": "Underspent. Major works include road construction and upgrading of ramp/workshop. (Source: PA 2/2025, Pg. 81-83)",
                        "Immature": "N/A"
                    },
                    "audit": {
                        "Overall Rating": "Marginally Deficient. While most key controls were applied, some important controls lacked consistency or effectiveness, requiring timely corrective action. (Source: Audit Report 16/25, Pg. 2)",
                        "Payroll and Personnel": "Shortcomings in Quarto Connects attendance records were identified, including manual amendments after biometric capture and entries at odd hours. This undermines the system's reliability. (Source: Audit Report 16/25, Pg. 2-4)",
                        "Rest Day Payment": "FFB Checkers were paid for rest day work without corresponding productivity (no bunch count chits). This indicates a lack of verification before payment and has led to unjustifiable wage expenses. (Source: Audit Report 16/25, Pg. 8-9, 12)"
                    },
                    "pinfosys": "N/A"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Weeding Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: WEED-CTRL-03:</b> Prioritize circle weeding before fertilizer application to prevent nutrient competition. Ensure inter-row spraying is completed on schedule to suppress woody regeneration.</p></div> <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer application must strictly adhere to the schedule. Delays beyond 15 days require a mitigation plan to avoid yield losses.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting & Crop Recovery</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Harvesting intervals must be maintained within 15 days. A dedicated loose fruit collection process must be enforced to maximize recovery.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Weeding') ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">A monthly Production vs. Rainfall chart cannot be generated as monthly FFB production data is not available in the reports.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Production vs Rainfall</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Audited Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate(estate) {
                const prodCanvasId = `prodChart-${estate.id}`;
                const ageCanvasId = `ageChart-${estate.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && estate.chartData.production.labels && estate.chartData.production.labels.length > 0) {
                    const datasets = [];
                    if (estate.chartData.production.ffb && estate.chartData.production.ffb.length > 0) {
                        datasets.push({ label: 'FFB Yield (MT/Ha)', data: estate.chartData.production.ffb, type: 'line', borderColor: '#ca8a04', backgroundColor: 'transparent', yAxisID: 'y-ffb', tension: 0.4 });
                    }
                    if (estate.chartData.production.rainfall && estate.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estate.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estate.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Yield (MT/Ha)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estate.chartData.ageProfile.data && estate.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estate.chartData.ageProfile.labels,
                            datasets: [{ data: estate.chartData.ageProfile.data, backgroundColor: ['#064e3b', '#059669', '#6ee7b7', '#d1fae5'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: estate.chartData.ageProfile.title, font: {size: 14} }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns(estate) {
                const agronomyDiv = document.getElementById(`${estate.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estate.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estate.id}-pinfosys`);
                const auditDiv = document.getElementById(`${estate.id}-audit`);

                if (agronomyDiv && estate.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estate.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                } else if (agronomyDiv) {
                    agronomyDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }

                if (plantationDiv && estate.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estate.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                } else if (plantationDiv) {
                    plantationDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }

                if (pinfosysDiv && estate.reports.pinfosys === "N/A") {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                } else if (pinfosysDiv && estate.reports.pinfosys) {
                     pinfosysDiv.innerHTML = Object.entries(estate.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }

                if (auditDiv && estate.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estate.reports.audit).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                } else if (auditDiv) {
                    auditDiv.innerHTML = `<p class="text-sm text-gray-600">Not Available</p>`;
                }
            }

            function attachEventListeners(estate) {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estate));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
