<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Tanjung Nipis Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "tanjungnipis",
                "name": "Tanjung Nipis Estate",
                "reportInfo": "Data based on PA Report (May 2025) & Agronomy Report (May 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,414.10 ha",
                            "Mature: 1,317.73 ha",
                            "Immature: 96.37 ha",
                            "Includes Tobe Division (539.10 ha)"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (Actual vs Budget)",
                        "value": "16.35 / 22.23 MT",
                        "note": "26% below budget (FY 24/25)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Actual vs Budget)",
                        "value": "RM 384.72 / RM 324.82",
                        "note": "18% higher than budget"
                    },
                    "labour": {
                        "title": "Labour Status",
                        "value": "Critical Shortage",
                        "note": "Shortage of 27 workers (24 harvesters)"
                    },
                     "pests": {
                        "title": "Pest Status",
                        "value": "Under Control",
                        "note": "Rat incidence manageable"
                    }
                },
                "keyMetrics": [
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>", "label": "Harvester Shortage", "value": "Short 24 Harvesters" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>", "label": "Weeding", "value": "Delayed (1.2 - 1.45 Rds)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>", "label": "Harvest Interval", "value": "20-29 days (Poor)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2' /></svg>", "label": "Manuring", "value": "Delayed >2 Months" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-orange-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z' /></svg>", "label": "Rehabilitation", "value": "Tobe Div. (Active)" },
                    { "icon": "<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 7h8m0 0v8m0-8l-8 8-4-4-6 6' /></svg>", "label": "Yield", "value": "16.35 MT/Ha (Low)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-24", "Jun-24", "Jul-24", "Aug-24", "Sep-24", "Oct-24", "Nov-24", "Dec-24", "Jan-25", "Feb-25", "Mar-25", "Apr-25"],
                        "ffb": [], // Monthly FFB not explicitly detailed in extract, chart will show rainfall or placeholder note
                        "rainfall": [154, 267, 270, 241.5, 225, 123, 323, 444, 978.5, 550, 381, 180],
                        "note": "*Rainfall data (mm) from Agronomy Report 1/2025, Pg. 65. Monthly FFB production data not detailed in summary tables."
                    },
                    "ageProfile": {
                        "labels": ["0-3 Years (Immature)", "4-7 Years (Young Mature)", "8-19 Years (Prime)", "20-25 Years (Old)", ">26 Years (Old)"],
                        "data": [7, 6, 40, 48, 0], // Percentages from Agronomy Report Pg 12
                        "title": "Tanjung Nipis - Palm Age Distribution (2025)",
                        "note": "*Source: Agronomy Report 1/2025, Pg. 12."
                    }
                },
                "observations": [
                    "<b>Critical Labour Shortage:</b> The estate is facing a shortage of 27 workers, specifically 24 harvesters. This has severely impacted harvesting operations, leading to extended intervals. The current ratio is 1 worker to 12 hectares. <span class='observation-ref'>(PA Report 01/2025, Pg. 16-17)</span>",
                    "<b>Poor Harvesting Efficiency:</b> Harvesting intervals have been inconsistent and extended, ranging up to 29 days in April 2025. This has resulted in crop loss and poor recovery. Harvester productivity is low, averaging between 0.7 to 1.81 MT per man-day. <span class='observation-ref'>(PA Report 01/2025, Pg. 54-56; Agronomy Report 1/2025, Pg. 17)</span>",
                    "<b>Tobe Division Rehabilitation:</b> The newly acquired Tobe Division (539.10 ha) is in poor condition, characterized by severe under-pruning and weed dominance. Massive rehabilitation pruning and weeding are currently ongoing, contributing to higher upkeep costs. <span class='observation-ref'>(PA Report 01/2025, Pg. 31, 43; Agronomy Report 1/2025, Pg. 36)</span>",
                    "<b>Weeding & Ground Maintenance Delays:</b> Weeding is significantly behind schedule. Inter-row spraying has only completed 1.45 rounds and circle spraying 1.2 rounds, against a target of 3 rounds per year. Field conditions in some areas are becoming \"mini jungles\". <span class='observation-ref'>(PA Report 01/2025, Pg. 23-28; Agronomy Report 1/2025, Pg. 29)</span>",
                    "<b>Manuring Schedule Delays:</b> The FY2024/25 manuring program was completed but with significant delays (up to 6 months late for some blocks). The new FY2025/26 program has started slowly with only 5% completion as of May 2025. <span class='observation-ref'>(Agronomy Report 1/2025, Pg. 14)</span>",
                    "<b>High Production Cost vs. Low Yield:</b> The ex-estate production cost stands at RM 384.72 per MT, which is 18% above the budget of RM 324.82. This is primarily driven by the low yield of 16.35 MT/ha (23% below budget) and high rehabilitation expenditures. <span class='observation-ref'>(PA Report 01/2025, Pg. 63)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate's performance is moderate and requires significant improvement. Key issues are the low yield (16.35 MT/ha), shortage of 24 harvesters, and delayed weeding. The acquisition of the Tobe Division (539.10 ha) presents a major rehabilitation challenge. The harvesting interval remains unacceptable at 20-29 days. (Source: PA Report, Pg. 67-68)",
                        "Area Statement": "Total planted area is 1,414.10 ha. This includes the Main Division (848.10 ha mature) and the newly acquired Tobe Division (469.63 ha mature). Immature area stands at 96.37 ha (Main: 17.37 ha; Tobe: 69.47 ha). The Tobe Division blocking system is irregular (sub-blocks range 10-50 ha) and requires reblocking. (Source: PA Report, Pg. 10-13)",
                        "Labour Statement": "Total workforce is 114 against a requirement of 141 (-27). Critical shortage of 24 harvesters and 8 pruners. Harvester ratio is 1:21 ha, which is insufficient for the steep terrain (65% hilly). Immediate recruitment is required. (Source: PA Report, Pg. 16-17)",
                        "Staff Establishment": "Staff establishment is satisfactory but requires expansion for Tobe. Currently: 1 Manager, 1 Assistant Manager (Tobe), 4 Field Conductors (3 Main, 1 Tobe). An additional Assistant Manager and Field Conductor are needed for June 2025. (Source: PA Report, Pg. 15)",
                        "General Charges": "Expenditure is 7% below budget (RM 1,889.27/ha vs RM 2,091.80/ha). However, significant overspending occurred in: Staff Welfare (+56%) due to seminars; Office Expenses (+170%) due to consultant fees; License & Permits (+208%) due to genset renewal; and Upkeep of Lines (+83%) due to repairs. (Source: PA Report, Pg. 18-20)",
                        "Upkeep and Cultivation": "Total upkeep cost is RM 212.70/ha. Weeding is delayed: Inter-row spraying completed 1.45 rounds (Target: 3.0), Circle spraying 1.2 rounds (Target: 3.0). Weeding cost is high at RM 79.31/ha (233% of budget) due to heavy weed density. Manuring cost is RM 874.33/ha (42% below budget) due to lower material costs. Pruning cost is high (RM 357/ha) due to rehab work. (Source: PA Report, Pg. 22-35)",
                        "Harvesting and Collection": "Cost is RM 110.79/tonne (1.57% above budget). Harvesting intervals are poor (12-29 days), causing crop loss. Harvester productivity varies widely (0.7 - 1.81 MT/man-day). Mechanization is used (6 mini crawlers), but 2 units are standby/underutilized. (Source: PA Report, Pg. 52-58)",
                        "Crop Production": "Total FFB production was 13,632 MT, which is 23% below the budget of 17,604 MT. Yield per hectare is 16.35 MT. The shortfall is attributed to labor shortages, extended harvesting intervals, and rehabilitation works. (Source: PA Report, Pg. 61)",
                        "Production Cost": "Ex-estate cost is RM 384.72/tonne, 18% higher than the budget of RM 324.82. Key cost drivers: Upkeep & Cultivation (RM 158.45/tonne) and General Charges (RM 115.47/tonne). (Source: PA Report, Pg. 63)",
                        "Vehicles Running Cost": "Generally acceptable. Tractors run at RM 0.93 - RM 2.94/hr. Mini crawlers cost RM 0.93 - RM 2.94/hr when active, but standby units cost RM 5.46/hr due to underutilization. (Source: PA Report, Pg. 64-65)",
                        "Capital Expenditure": "Road upgrading is a priority. 26,828 meters of road compacting completed in Main Division and 10,861 meters in Tobe. Red stone surfacing cost is RM 51.11/tonne. Total road/bridge cost is RM 874.16/ha (49% over budget). (Source: PA Report, Pg. 46-48)",
                        "Immature": "Main Division (17.37 ha): Block 48 planted Sep 2024; Block 49 land prep ongoing. Tobe Division (69.47 ha): Block A4 and A5 appear healthy but access is difficult. Spraying program is overdue in immature areas. (Source: PA Report, Pg. 66)"
                    },
                    "agronomy": {
                        "Executive Summary": "Yield performance is below expectation due to extended harvesting intervals and manuring delays. Tobe division requires significant rehabilitation. Crop recovery is improving but inconsistent. (Source: Agronomy Report, Pg. 4-6)",
                        "Nutrient Inputs/Progress of Manuring": "FY2024/25 program completed (102% for NK Mixture due to surplus stock use), but with critical delays of 3-6 months in Blocks 58, 63, 64, 65, 66, 67, 68. FY2025/26 program started slowly (5% completion as of May). Fertilizer application quality issues (lumps, narrow bands) noted in Block 53. (Source: Agronomy Report, Pg. 13-15)",
                        "Agronomic Observation": "Main Division: Palm condition is generally satisfactory, but etiolation observed in Block 64 and nutrient deficiency in Block 80. Pruning is acceptable (2 rounds completed) but frond stacking is inconsistent (messy in Blocks 48, 49, 60). Weeding is fair but VOPs are increasing in palm circles. (Source: Agronomy Report, Pg. 17-35)",
                        "Tobe Division Observations": "Harvesting started Jan 2025 in accessible areas. Crop quality issue: overripe bunches found in Block 91 due to delayed entry. Severe under-pruning across most blocks; only 33% of palms pruned as of April. Ground maintenance is inadequate with broadleaf weeds and soft woodies dominating. (Source: Agronomy Report, Pg. 36-44)",
                        "Yield Performance": "Yield of 16.35 MT/ha is 2% lower than FY23/24 (16.67 MT/ha). Significant yield drops in Block 05A (-36%) and 05B (-18%). Harvesting rounds achieved were only 17.9 rounds/year against a target of >24, averaging 1.5 rounds/month. (Source: Agronomy Report, Pg. 58-59)",
                        "Fertilizer Recommendation": "Main Division: Program remains unchanged. New Property (Tobe): Specific program created. Recommendation includes Mix A, Mix B, NK, and RP. Immature areas (Block 48, 49) to receive CPD and RP. (Source: Agronomy Report, Pg. 62-64)"
                    },
                    "pinfosys": "N/A"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> All fertilizer applications must be completed according to the schedule. Delays beyond 2 months as seen in Block 58-68 are critical non-compliances.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-INT-01:</b> Harvesting intervals must be maintained below 15 days. Current intervals of up to 29 days are unacceptable.</p></div> <div class='policy-item'><p class='font-semibold'>Weeding Control</p><p class='text-sm text-gray-600'><b>Policy Ref: AGRO-WEED-02:</b> Inter-row spraying must be conducted at 3 rounds per year. Current status of 1.45 rounds is insufficient to control noxious weeds.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Labour') ? 'bg-red-50 text-red-800' : 'bg-gray-50 text-gray-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">Chart data not available.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Rainfall (mm) - FY 24/25</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-green-800 text-white px-6 py-3 rounded-lg hover:bg-green-900 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: [
                                { label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-rainfall': { type: 'linear', position: 'left', title: { display: true, text: 'Rainfall (mm)' } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#047857', '#34d399', '#a7f3d0', '#065f46', '#d1fae5'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (pinfosysDiv) {
                    pinfosysDiv.innerHTML = `<p class="text-sm text-gray-600">${estateData.reports.pinfosys}</p>`;
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
