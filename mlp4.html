<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>MLP 4 Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                MLP 4 Estate Report <span class="text-sm font-normal text-gray-500 block">Visit Date: November 2025 (PA) / October 2025 (Agronomy)</span>
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "mlp4",
                "name": "MLP 4 Estate",
                "reportInfo": "Data based on Plantation Advisory Report No. 2/2025 (Visit: 31st Oct - 1st Nov 2025) and Agronomy Report (Oct 2025).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,280.20 ha",
                            "Mature: 1,280.20 ha",
                            "Unplanted: 504.76 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (Actual vs Budget)",
                        "value": "7.53 / 8.42 MT",
                        "note": "Sept 2025 YTD (PA Report)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Actual vs Budget)",
                        "value": "RM 316.23 / 327.62",
                        "note": "Sept 2025 YTD (Ex-Estate)"
                    },
                    "manuring": {
                        "title": "Manuring Progress",
                        "value": "53% Completed",
                        "note": "Till Sept 2025 (PA Report)"
                    },
                     "labour": {
                        "title": "Labour Status",
                        "value": "Shortage: 13",
                        "note": "Total Workers: 142/155"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Shortage", "value": "5 Vacancies (1:16 ha)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "Harvest Interval", "value": "~18 Days (High)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (Sept YTD)", "value": "20.26%" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Weeding Status", "value": "Unsatisfactory" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.343A8 8 0 016.343 7.029m11.314 11.314a8 8 0 01-11.314-11.314m2.121 13.435a2 2 0 01-2.828 0l-2.122-2.121a2 2 0 010-2.828l5.656-5.657a2 2 0 012.829 0l2.121 2.121a2 2 0 010 2.828l-5.657 5.657z' /></svg>`, "label": "Upkeep Cost", "value": "35% Underspent" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-25", "Jun-25", "Jul-25", "Aug-25", "Sept-25"],
                        "ffb": [], 
                        "rainfall": [383, 61, 322, 217, 309],
                        "note": "*Rainfall data from Agronomy Report. FFB trend not explicitly tabulated month-on-month in summary."
                    },
                    "ageProfile": {
                        "labels": ["Mature (>3 Years)", "Immature (0-3 Years)"],
                        "data": [1280.20, 0],
                        "title": "MLP 4 Estate - Palm Age Distribution",
                        "note": "*Source: PA Report 2/2025, Pg. 9."
                    }
                },
                "observations": [
                    "<b>Critical Labour Shortage (PA Nov 25):</b> High turnover has led to a shortage of 13 workers, specifically 5 harvesters. This directly impacts harvesting rounds and crop recovery. <span class='observation-ref'>(PA 2/2025, Pg. 12, 84)</span>",
                    "<b>Unsatisfactory Field Conditions (PA Nov 25):</b> Weeding is poor with prevalent woodies, VOPs, bamboo, and giant paspalum. Selective spraying (46% complete) missed many woody plants. <span class='observation-ref'>(PA 2/2025, Pg. 27, 36)</span>",
                    "<b>Road Infrastructure Issues (PA Nov 25):</b> Roads are steep, bumpy, and prone to erosion. This hampers FFB evacuation and material transport. <span class='observation-ref'>(PA 2/2025, Pg. 61, 85)</span>",
                    "<b>Production Shortfall (PA Nov 25):</b> Sept YTD yield is 7.53 MT/ha, which is 11% below the budget of 8.42 MT/ha. This is attributed to the harvester shortage and low outturn (58%). <span class='observation-ref'>(PA 2/2025, Pg. 71-72)</span>",
                    "<b>Manuring Delays (Agro Oct 25 / PA Nov 25):</b> Manuring is only 53% complete against the budget. Delays are due to late fertilizer delivery and difficult terrain/machinery breakdown. <span class='observation-ref'>(PA 2/2025, Pg. 50; AR Oct-25)</span>",
                    "<b>Harvesting Operations (Agro Oct 25):</b> While the average interval is reported as ~18 days by PA, Agronomy noted extreme intervals of 10-40 days in Field 12B, causing crop loss. <span class='observation-ref'>(PA 2/2025, Pg. 67; AR Oct-25)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate faces high labour turnover due to difficult terrain. Shortages in harvesters and upkeep workers are critical. Field conditions are unsatisfactory with significant weed issues. Production is disappointing due to these factors. (Source: PA 2/2025, Pg. 84-85)",
                        "Area Statement": "Mature area stands at 1,280.20 ha. There is no immature area listed. Total land for cultivation is 1,280.20 ha. Rehabilitation of 24 ha is completed. (Source: PA 2/2025, Pg. 9-10)",
                        "Labour Statement": "Total actual workers: 142 vs Requirement: 155. Harvester ratio is 1:16 ha (short of 5). Sprayers and manuring workers are also insufficient. (Source: PA 2/2025, Pg. 12-13)",
                        "Staff Establishment": "Staff establishment is satisfactory and adequate. No changes noted. (Source: PA 2/2025, Pg. 14)",
                        "General Charges": "Sept YTD Actual: RM 1,296,789 vs Budget: RM 1,285,948 (+1%). Overspending noted in office equipment maintenance (1325%) and staff reimbursement. (Source: PA 2/2025, Pg. 19-21)",
                        "Upkeep & Cultivation": "Sept YTD Actual: RM 875,503 vs Budget: RM 1,343,565 (-35%). Underspending due to delayed weeding and manuring programs. Circle spraying 46% complete; Selective spraying 46% complete. (Source: PA 2/2025, Pg. 25, 29, 36)",
                        "Harvesting and Collection": "Sept YTD Cost: RM 1,013,479 vs Budget: RM 899,399 (+13%). Cost is high due to incentives and manual loading expenses. Harvesting interval average is 18 days. (Source: PA 2/2025, Pg. 65, 67)",
                        "Crop Production": "Sept YTD FFB: 9,643 MT vs Budget: 10,779 MT (-11%). Yield is 7.53 MT/ha. Shortfall due to low harvester outturn (58%). (Source: PA 2/2025, Pg. 71-72)",
                        "Production Cost": "Sept YTD (Ex-Estate): RM 316.23/tonne vs Budget: RM 327.62/tonne. Lower cost per tonne is primarily due to underspending in upkeep, despite high harvesting costs. (Source: PA 2/2025, Pg. 74)",
                        "Vehicles Running Cost": "Tractor costs are high due to frequent repairs. Backhoe and crawlers are underutilized, leading to high unit costs. (Source: PA 2/2025, Pg. 79)",
                        "Capital Expenditure": "Capex is generally underspent. Road gravelling and culvert works are in progress. (Source: PA 2/2025, Pg. 82)",
                        "Immature": "N/A"
                    },
                    "agronomy": {
                        "Executive Summary": "Yield performance (Sep YTD) is 5% higher than last year but remains below potential. Key limiting factors are inadequate harvesters, poor road accessibility, and delayed manuring application. (Source: AR Oct-25, Pg. 4-6)",
                        "Nutrient Inputs/Progress of Manuring": "Program is delayed. Mix B is 46% complete, Kieserite 71% complete, and BRP 35% complete. Delays are due to late delivery (Mix B arrived July) and transport machinery breakdowns. (Source: AR Oct-25, Pg. 13-14)",
                        "Agronomic Observation": "Harvesting intervals are highly inconsistent (10-40 days). Pruning is significantly behind schedule (1% complete). Weeding is fair generally but poor in P12B (39% circle spray). Magnesium deficiency observed in localized hilly areas. (Source: AR Oct-25, Pg. 17, 27, 33)",
                        "Yield Performance": "YTD Yield (Period 5) is 7.53 MT/Ha, up from 7.17 MT/Ha last year. Field P12B yield declined by 14% due to extended harvesting intervals. (Source: AR Oct-25, Pg. 44)",
                        "Fertilizer Recommendation": "FY2025/2026 program remains unchanged. Estate must expedite application to ensure completion. FY2026/2027 program outlined for budgeting. (Source: AR Oct-25, Pg. 47)"
                    },
                    "pinfosys": {
                        "CEO Financial Summary": "N/A",
                        "Summary of Oil Palm Expenditure": "N/A"
                    }
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Manuring Delays</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer applications must adhere to schedule. Delays >15 days must have a mitigation plan. Current delays >2 months are critical non-compliance.</p></div> <div class='policy-item'><p class='font-semibold'>Harvesting Intervals</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Harvesting intervals must be maintained below 15 days. Current intervals of 18-40 days require immediate rectification to prevent crop loss.</p></div> <div class='policy-item'><p class='font-semibold'>Weeding Standards</p><p class='text-sm text-gray-600'><b>Policy Ref: FIELD-WEED-01:</b> Circles must be kept clean of noxious growths. The presence of woodies and bamboo in circles indicates supervision failure.</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Manuring') ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');

                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) || (estate.chartData.production.rainfall && estate.chartData.production.rainfall.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">Chart data not available.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Monthly Rainfall (2025)</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                             <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate(estate) {
                const prodCanvasId = `prodChart-${estate.id}`;
                const ageCanvasId = `ageChart-${estate.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && estate.chartData.production.rainfall) {
                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estate.chartData.production.labels,
                            datasets: [
                                { label: 'Rainfall (mm)', data: estate.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                x: { grid: { display: false } }, 
                                'y-rainfall': { type: 'linear', position: 'left', title: { display: true, text: 'Rainfall (mm)' } } 
                            } 
                        }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estate.chartData.ageProfile.data) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estate.chartData.ageProfile.labels,
                            datasets: [{ data: estate.chartData.ageProfile.data, backgroundColor: ['#047857', '#fbbf24'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns(estate) {
                const agronomyDiv = document.getElementById(`${estate.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estate.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estate.id}-pinfosys`);

                if (agronomyDiv && estate.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estate.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estate.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estate.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (pinfosysDiv && estate.reports.pinfosys) {
                    pinfosysDiv.innerHTML = Object.entries(estate.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
            }

            function attachEventListeners(estate) {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estate));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
