<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Bukit Senorang Estate - Plantation and Agronomy Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .details-content { display: none; }
        .details-content.active { display: block; }
        .dropdown-btn.active { background-color: #14532d; } /* dark green */
        .policy-item { border-left: 3px solid #16a34a; padding-left: 1rem; margin-top: 0.75rem; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .chart-container { position: relative; height: 300px; width: 100%; margin: auto; }
        .pie-chart-container { position: relative; height: 350px; width: 100%; margin: auto; }
        .observation-ref { font-size: 0.75rem; color: #57534e; font-style: italic; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <nav class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div id="header-title" class="text-xl font-bold text-gray-900">
                <!-- Title will be populated by JS -->
            </div>
            <a href="estates.html" class="text-green-800 hover:text-green-900 transition duration-300">&larr; Back to Estates List</a>
        </nav>
    </header>

    <!-- Main container for the report -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Container where the estate data will be rendered -->
        <div id="selected-estate-container" class="grid grid-cols-1 gap-8">
             <!-- Content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Modal for displaying policy details -->
    <div id="policyModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold">Agricultural Policy Cross-Reference</h3>
                <button onclick="closePolicyModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="modalContent" class="space-y-4 overflow-y-auto pr-4 flex-grow">
                <!-- Modal content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main script for application logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            const estateData = {
                "id": "bukitsenorang",
                "name": "Bukit Senorang Estate",
                "reportInfo": "Data based on PA Report (Nov 2025), Agronomy Visit (24th June 2025), and Audit Report (20/25).",
                "summaryMetrics": {
                    "area": {
                        "title": "Estate Area",
                        "lines": [
                            "Total Planted: 1,520.82 ha",
                            "Mature: 1,289.58 ha",
                            "Immature: 231.24 ha"
                        ]
                    },
                    "yield": {
                        "title": "Yield/Ha (Actual vs Budget)",
                        "value": "11.04 / 10.02 MT",
                        "note": "May-Oct 2025 (14% above budget)"
                    },
                    "cost": {
                        "title": "FFB Cost/Tonne (Actual vs Budget)",
                        "value": "RM 246.11 / RM 316.78",
                        "note": "May-Oct 2025 (22% below budget)"
                    },
                     "pests": {
                        "title": "Pest Status",
                        "value": "Medium Risk",
                        "note": "Bagworm controlled; Ganoderma severe"
                    },
                    "weeding": {
                        "title": "Weeding Progress",
                        "value": "Satisfactory",
                        "note": "Selective spraying 48% completed"
                    }
                },
                "keyMetrics": [
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-blue-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Labour Ratio", "value": "1:13 ha (Adequate)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-red-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' /></svg>`, "label": "P&D Status", "value": "Severe (Ganoderma)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 10V3L4 14h7v7l9-11h-7z' /></svg>`, "label": "OER % (May-Oct)", "value": "19.42% (Low)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-green-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z' /></svg>`, "label": "Harvester Prod.", "value": "3.53 MT/md (Good)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-purple-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' /></svg>`, "label": "Harvest Interval", "value": "10-18 days (Acceptable)" },
                    { "icon": `<svg xmlns='http://www.w3.org/2000/svg' class='h-6 w-6 text-yellow-600' fill='none' viewBox='0 0 24 24' stroke='currentColor'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' /></svg>`, "label": "Vehicle Cost", "value": "High (Tractors)" }
                ],
                "chartData": {
                    "production": {
                        "labels": ["May-Oct 24"],
                        "ffb": [14671],
                        "rainfall": [],
                        "note": "*Detailed monthly production data not provided in summary text. Total FFB for May-Oct 2025: 14,671.62 MT."
                    },
                    "ageProfile": {
                        "labels": ["Mature (>4 Yrs)", "Immature/Replanting (<4 Yrs)"],
                        "data": [1289.58, 231.24],
                        "title": "Bukit Senorang Estate - Palm Age Distribution (Nov 2025)",
                        "note": "*Source: PA Report 2/2025, Pg. 10."
                    }
                },
                 "observations": [
                    "<b>Ganoderma Infection (Critical):</b> The disease remains the primary issue in old palm areas (P98, P00), causing significant stand loss. Mounding has been completed in P05, but replanting is the long-term solution. <span class='observation-ref'>(PA Pg. 34, 50; Agro Pg. 50-52)</span>",
                    "<b>Manuring Program Delayed:</b> As of October 2025, only 39% of the annual fertilizer program was completed. First-half applications of Rock Phosphate and NK Mix were delayed due to delivery issues. <span class='observation-ref'>(PA Pg. 29-30)</span>",
                    "<b>High Vehicle Running Costs:</b> Several Landini farm tractors recorded running costs >400% above budget (e.g., WVN 6550 at RM 146/hr vs RM 27/hr). Underutilization and high repair costs are key factors. <span class='observation-ref'>(PA Pg. 49)</span>",
                    "<b>Weeding Progress:</b> While general weeding is satisfactory, selective spraying in young mature areas is behind schedule (48% of annual program). Noxious weeds like Clidemia hirta require continued attention. <span class='observation-ref'>(PA Pg. 21, 50; Agro Pg. 37)</span>",
                    "<b>Harvesting Performance:</b> Harvester productivity has improved to 3.53 MT/man-day due to mechanization (MTG). However, adherence to harvesting standards in tall palms (minimizing missed bunches) remains a priority from the agronomy visit. <span class='observation-ref'>(PA Pg. 41; Agro Pg. 25)</span>",
                    "<b>Bagworm Control:</b> High expenditure incurred for Bagworm treatment (RM 93/ha vs RM 26/ha budget). The situation is currently controlled with no fresh outbreaks noted. <span class='observation-ref'>(PA Pg. 32, 50)</span>"
                ],
                "reports": {
                    "plantation": {
                        "Executive Summary": "The estate's overall performance for the May-Oct 2025 period is acceptable and shows significant improvement. FFB production is 14% above budget, and the cost of production is 22% below budget. Key management focuses include eliminating noxious weeds, completing the delayed manuring program, and managing the aggressive replanting schedule for Fields 2025. Vehicle running costs for specific tractors remain a concern due to high repair costs. (Source: PA 2/2025, Pg. 50-51)",
                        "Area Statement": "The total planted area stands at 1,520.82 ha. The mature area has been reduced to 1,289.58 ha following the replanting of 101.58 ha (Fields 1998C/D, 2000B). The immature area has increased to 231.24 ha, comprising Fields 2025 A-G. Future replanting is scheduled for 179.60 ha in FY 2026/27 and 102.30 ha in FY 2027/28. Watermelon intercropping is in progress on 59.03 ha of the replanting area. (Source: PA 2/2025, Pg. 10-11)",
                        "Labour Statement": "The estate employs 114 workers (Checkroll), achieving a worker-to-land ratio of 1:13 ha, which is considered adequate. There is a shortage of 14 workers against the requirement of 128. Harvester strength is 53 (1:24 ha). Harvesting and collection in Fields 2018 and 2020 (239.88 ha) have been successfully contracted out to FK Construction & Plantation Growth Enterprise. The estate is advised to expand the contract system to other fields if performance remains good. (Source: PA 2/2025, Pg. 12-13)",
                        "Staff Establishment": "The estate is managed by Senior Manager En. Mohamed Rezal Bin Bakal. The Senior Assistant Manager post is vacant following a resignation. There is a shortage of 2 Field Conductors, which is critical given the aggressive replanting activities. The recommendation is to recruit additional supervision immediately. (Source: PA 2/2025, Pg. 15-16)",
                        "General Charges": "Total expenditure was RM 1,179,835 (RM 776/ha), which is 9% below the seasonal budget. However, significant overspending was noted in: <br>• <b>Staff Welfare (493% above budget):</b> Due to training salaries and practical student payments.<br>• <b>Computer Maintenance (63% above budget):</b> Higher costs for Quarto Connect fees.<br>• <b>Insurance & Road Tax (15% above budget):</b> Increased costs for fire and burglary policies. (Source: PA 2/2025, Pg. 17-19)",
                        "Upkeep & Cultivation": "Total upkeep cost was RM 1,022.99/ha (27% below budget). <br>• <b>Weeding:</b> Circle spraying is 51% complete; selective spraying is 48% complete. Noxious weeds (Clidemia hirta, Asystasia) require attention in young mature areas.<br>• <b>Manuring:</b> Only 39% of the annual program is complete. Delays noted in Rock Phosphate (RP) and NK Mix due to delivery issues.<br>• <b>Pest Control:</b> Bagworm treatment cost (RM 93/ha) exceeded budget by 258% due to past severe infections, though currently controlled. Rat baiting cost is low (RM 14/ha). (Source: PA 2/2025, Pg. 20-39)",
                        "Harvesting and Collection": "Total cost is RM 83.05/MT, 11% below the budget of RM 92.84/MT. Infield loading cost (RM 8.67/MT) is 30% below budget. Mechanization using Mini Tractor Grabbers (MTG) is effective, with harvester productivity at 3.53 MT/man-day (including drivers). Harvesting intervals are maintained between 10-18 days. The estate is encouraged to contract out the entire harvesting package (cutting + collection) to a single contractor for efficiency. (Source: PA 2/2025, Pg. 40-43)",
                        "Crop Production": "The estate produced 14,671.62 MT of FFB for the 6-month period (May-Oct), which is 11.04 MT/ha. This is 14% higher than the seasonal budget of 12,926 MT. <br>• <b>CPO Production:</b> 2,849.23 MT (OER: 19.42%)<br>• <b>Kernel Production:</b> 1,107.78 MT (KER: 4.64%)<br>Yield performance is satisfactory across all fields. (Source: PA 2/2025, Pg. 44)",
                        "Production Cost": "The ex-estate cost of production stands at RM 246.11/MT, significantly lower (22%) than the seasonal budget of RM 316.78/MT. This favorable variance is driven by higher-than-budgeted crop production and savings in upkeep and harvesting costs. (Source: PA 2/2025, Pg. 45)",
                        "Vehicles and Machinery": "The estate operates 10 farm tractors and 12 mini-tractors. Running costs for specific units are excessively high due to breakdowns and low utilization: <br>• <b>Landini WVN 6550:</b> RM 146/hr (Budget: RM 27/hr)<br>• <b>Landini WYW 4562:</b> RM 64/hr (Budget: RM 10/hr)<br>Recommendation: Sell 2 unutilized farm tractors and 3 mini-tractors to reduce overhead. (Source: PA 2/2025, Pg. 48-49)",
                        "Replanting & Immature": "<b>Field 2025 A-D (129.66 ha):</b> Planting completed in June 2025. Palm density is 148 palms/ha. Watermelon intercropping is ongoing.<br><b>Field 2025 E-G (101.58 ha):</b> Felling, deboling, and land preparation are complete. Palm planting is scheduled to commence in November 2025. (Source: PA 2/2025, Pg. 46-47)"
                    },
                    "agronomy": {
                        "Executive Summary": "The estate's agronomic condition is generally acceptable, but several key issues require immediate attention. Manuring for FY2024/25 was completed, but with delays. Weeding progress has been slow, leading to overgrown conditions. Pest control is a major concern, with significant Ganoderma infection, bagworm infestations, and high rat damage. Harvesting quality, particularly in older plantings, needs improvement to ensure full crop recovery. (Source: Agro, Pg. 4-8)",
                        "Nutrient inputs progress of manuring": "The full fertilizer program for FY2024/25 was completed, but there were delays of over two months for NK mixture and rock phosphate applications. Fertilizer storage conditions have improved with the use of pallets. Compost application was completed in P2001, P2002, and P2005, but progress was slow in P18 and had not started in P20 and P22. (Source: Agro, Pg. 17-21)",
                        "Agronomic observation": "Crop recovery is acceptable, but harvesting standards in tall palm areas (P01B) need improvement to avoid missed bunches and ensure complete loose fruit collection. Pruning is generally acceptable, but some subblocks are under-pruned. Palm appearance is affected in laterite and low-lying, flood-prone areas. Weeding progress is slow, with several blocks overgrown with broadleaf weeds, impacting accessibility. (Source: Agro, Pg. 24-42)",
                        "Pest and Disease Control": "Rat damage census indicates infestation levels exceeding the 20% threshold in several blocks, requiring a systematic baiting campaign. Barn owl occupancy remains low at 21%. Bagworm (Metisa plana) infestation was detected, and while treatments are ongoing, they need to be better organized for effectiveness. Ganoderma infection is significant in all old plantings, causing substantial palm loss and requiring sanitation measures like palm mounding and deboling. (Source: Agro, Pg. 43-52)",
                        "Yield performance": "The estate achieved a yield of 18.2 MT/ha in FY2024/25, a 22% increase from the previous year. Notable gains were seen across all fields. However, yields in older plantings (P98, P00) are limited by low palm density and Ganoderma. The yield potential in young mature areas like P20 has yet to be fully reached. (Source: Agro, Pg. 80-81)",
                        "Fertilizer recommendation": "The fertilizer program for FY2025/26 has been reviewed, and no amendments are deemed necessary at this time. The estate is advised to commence the application of Mixture B without further delay. The fertilizer requirement will be recalculated based on the latest palm density data in the next visit. (Source: Agro, Pg. 84)"
                    },
                    "audit": {
                        "Overall Rating": "Deficient. Key controls were not being applied, and weaknesses significantly impaired the overall system of internal control, requiring prompt corrective action. (Source: Audit Report, Pg. 2)",
                        "Contracts and Tenders": "Significant issues were noted, including a major delay in the 134.02 ha replanting project, requiring two extensions of time. Additionally, a mounding contract worth over RM 212,000 was awarded without competitive quotes and approved by the CEO instead of the Executive Director, violating the Authorization and Authority Limits. (Source: Audit Report, Pg. 3, 6-7)",
                        "Payroll and Personnel": "A critical loophole was found in the biometric face recognition system, which allowed attendance to be recorded using static photographs for workers who were on annual leave. This vulnerability compromises the reliability of attendance records. (Source: Audit Report, Pg. 10, 13)",
                        "Stores and Purchases": "Expensive and fast-moving harvesting tools were being purchased as direct charge items rather than being treated as stock items. This practice makes it difficult to monitor and trace the items, increasing the risk of misappropriation. (Source: Audit Report, Pg. 15-16)"
                    },
                    "pinfosys": "Not Available"
                },
                "policy": " <div class='policy-item'><p class='font-semibold'>Pest Control (Bagworm & Rats)</p><p class='text-sm text-gray-600'><b>Policy Ref: P&D-Bagworm-01:</b> Treat bagworm infestations with Bacillus thuringiensis (Bt) or trunk injection of Acephate. For rats, initiate baiting campaigns with second-generation rodenticides when damage exceeds thresholds. (Agro Pg. 48, 60)</p></div> <div class='policy-item'><p class='font-semibold'>Ganoderma Management</p><p class='text-sm text-gray-600'><b>Policy Ref: GANO-CTRL-01:</b> Conduct yearly Ganoderma census. For infected areas, implement palm mounding to prolong palm life and deboling/sanitation during replanting to reduce inoculum source. (Agro Pg. 51)</p></div> <div class='policy-item'><p class='font-semibold'>Manuring & Fertilizing</p><p class='text-sm text-gray-600'><b>Policy Ref: FERT-APP-05:</b> Fertilizer application must adhere to the schedule to avoid delays. Ensure proper storage on pallets and conduct quality control sampling during unloading. (Agro Pg. 17-19)</p></div> <div class='policy-item'><p class='font-semibold'>Pruning & Harvesting</p><p class='text-sm text-gray-600'><b>Policy Ref: HARV-STD-02:</b> Harvesting intervals should be maintained. Improve harvesting quality in tall palms to ensure all bunches and loose fruits are collected. Complete progressive pruning to facilitate harvesting. (Agro Pg. 25, 28)</p></div>"
            };


            // --- GLOBAL VARIABLES ---
            let chartInstances = {};
            const container = document.getElementById('selected-estate-container');

            // --- FUNCTIONS ---
            function renderEstate() {
                document.getElementById('header-title').innerText = `${estateData.name} Report`;
                container.innerHTML = createEstateHTML(estateData);
                setTimeout(() => {
                    initializeChartsForEstate(estateData);
                    populateInternalDropdowns(estateData);
                    attachEventListeners(estateData);
                }, 0);
            }

            function createEstateHTML(estate) {
                const summaryMetricsHTML = Object.values(estate.summaryMetrics).map(metric => {
                    const colorClass = metric.title.includes('Area') ? 'bg-blue-50 text-blue-800' : 
                                       metric.title.includes('Yield') ? 'bg-green-50 text-green-800' :
                                       metric.title.includes('Cost') ? 'bg-orange-50 text-orange-800' :
                                       metric.title.includes('Pest') ? 'bg-red-50 text-red-800' : 'bg-yellow-50 text-yellow-800';
                    if (metric.lines) {
                        return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3>${metric.lines.map(line => `<p class="text-sm">${line}</p>`).join('')}</div>`;
                    }
                    return `<div class="p-4 rounded-lg ${colorClass}"><h3 class="font-semibold">${metric.title}</h3><p class="text-2xl font-bold">${metric.value}</p><p class="text-xs text-gray-500 mt-1">${metric.note}</p></div>`;
                }).join('');

                const keyMetricsHTML = estate.keyMetrics.map(metric => `
                    <div class="flex items-center space-x-3 bg-gray-50 p-3 rounded-lg">
                        <div class="bg-gray-100 p-2 rounded-full">${metric.icon}</div>
                        <div><p class="text-sm text-gray-500">${metric.label}</p><p class="font-bold text-lg">${metric.value}</p></div>
                    </div>`).join('');

                const observationsHTML = estate.observations.map(obs => `<li class="ml-4">${obs}</li>`).join('');
                
                const productionChartHTML = (estate.chartData.production.labels && estate.chartData.production.labels.length > 0) || (estate.chartData.production.rainfall && estate.chartData.production.rainfall.length > 0) ?
                    `<div class="chart-container"><canvas id="prodChart-${estate.id}"></canvas></div>` :
                    `<div class="chart-container flex items-center justify-center bg-gray-50 rounded-lg p-4"><p class="text-gray-500 text-center">A monthly Production vs. Rainfall chart cannot be generated as monthly FFB production data is not available in the reports.</p></div>`;

                return `
                    <div class="bg-white p-6 rounded-lg shadow-lg animate-fade-in">
                        <h2 class="text-3xl font-bold mb-2 text-gray-900">${estate.name}</h2>
                        <p class="text-sm text-gray-500 mb-6 italic">${estate.reportInfo}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">${summaryMetricsHTML}</div>
                        <div class="mb-8"><h3 class="text-xl font-semibold mb-4 border-b pb-2">Key Metrics & Agronomic Status</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4">${keyMetricsHTML}</div></div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div><h3 class="text-xl font-semibold mb-2">Production vs Rainfall (Summary)</h3>${productionChartHTML}<p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.production.note}</p></div>
                            <div><h3 class="text-xl font-semibold mb-2">Palm Age Profile</h3><div class="pie-chart-container"><canvas id="ageChart-${estate.id}"></canvas></div><p class="text-xs text-center text-gray-500 mt-2">${estate.chartData.ageProfile.note}</p></div>
                        </div>
                        
                        <div class="mb-8">
                            <h3 class="text-xl font-semibold mb-2 border-b pb-2">Key Observations & Issues (Combined)</h3>
                            <ul id="observations-list" class="list-disc list-inside space-y-2 text-gray-700 mt-4">${observationsHTML}</ul>
                        </div>
                        
                        <div class="mb-8 text-center"><button class="policy-modal-btn bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition shadow-md">View Agricultural Policy Cross-Reference</button></div>
                        <div class="space-y-2">
                            <button data-dropdown-id="${estate.id}-plantation" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Plantation Advisory Report Details</button>
                            <div id="${estate.id}-plantation" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-agronomy" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Agronomy Report Details</button>
                            <div id="${estate.id}-agronomy" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-pinfosys" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Pinfosys Report Details</button>
                            <div id="${estate.id}-pinfosys" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                            <button data-dropdown-id="${estate.id}-audit" class="dropdown-btn w-full text-left bg-gray-800 text-white p-3 rounded-md hover:bg-gray-700 transition">Audited Report Details</button>
                            <div id="${estate.id}-audit" class="details-content bg-gray-50 p-4 rounded-md border border-gray-200"></div>
                        </div>
                    </div>`;
            }

            function initializeChartsForEstate() {
                const prodCanvasId = `prodChart-${estateData.id}`;
                const ageCanvasId = `ageChart-${estateData.id}`;
                if (chartInstances[prodCanvasId]) chartInstances[prodCanvasId].destroy();
                if (chartInstances[ageCanvasId]) chartInstances[ageCanvasId].destroy();

                const prodCtx = document.getElementById(prodCanvasId)?.getContext('2d');
                if(prodCtx && ((estateData.chartData.production.labels && estateData.chartData.production.labels.length > 0) || (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0))) {
                    const datasets = [];
                    if (estateData.chartData.production.ffb && estateData.chartData.production.ffb.length > 0) {
                        datasets.push({ label: 'FFB Production (MT)', data: estateData.chartData.production.ffb, type: 'bar', backgroundColor: '#ca8a04', yAxisID: 'y-ffb' });
                    }
                    if (estateData.chartData.production.rainfall && estateData.chartData.production.rainfall.length > 0) {
                        datasets.push({ label: 'Rainfall (mm)', data: estateData.chartData.production.rainfall, backgroundColor: '#3b82f6', yAxisID: 'y-rainfall' });
                    }

                    chartInstances[prodCanvasId] = new Chart(prodCtx, {
                        type: 'bar',
                        data: {
                            labels: estateData.chartData.production.labels,
                            datasets: datasets
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } }, 'y-ffb': { type: 'linear', position: 'left', title: { display: true, text: 'FFB Production (MT)' } }, 'y-rainfall': { type: 'linear', position: 'right', title: { display: true, text: 'Rainfall (mm)' }, grid: { drawOnChartArea: false } } } }
                    });
                }

                const ageCtx = document.getElementById(ageCanvasId)?.getContext('2d');
                if(ageCtx && estateData.chartData.ageProfile.data && estateData.chartData.ageProfile.data.length > 0) {
                    chartInstances[ageCanvasId] = new Chart(ageCtx, {
                        type: 'pie',
                        data: {
                            labels: estateData.chartData.ageProfile.labels,
                            datasets: [{ data: estateData.chartData.ageProfile.data, backgroundColor: ['#16a34a', '#facc15'], hoverOffset: 4 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: false }, legend: { position: 'right' } } }
                    });
                }
            }
            
            function populateInternalDropdowns() {
                const agronomyDiv = document.getElementById(`${estateData.id}-agronomy`);
                const plantationDiv = document.getElementById(`${estateData.id}-plantation`);
                const pinfosysDiv = document.getElementById(`${estateData.id}-pinfosys`);
                const auditDiv = document.getElementById(`${estateData.id}-audit`);

                if (agronomyDiv && estateData.reports.agronomy) {
                    agronomyDiv.innerHTML = Object.entries(estateData.reports.agronomy).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (plantationDiv && estateData.reports.plantation) {
                    plantationDiv.innerHTML = Object.entries(estateData.reports.plantation).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                if (pinfosysDiv && estateData.reports.pinfosys) {
                    pinfosysDiv.innerHTML = estateData.reports.pinfosys === "Not Available" ? `<p class="text-sm text-gray-600">Not Available</p>` : Object.entries(estateData.reports.pinfosys).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
                 if (auditDiv && estateData.reports.audit) {
                    auditDiv.innerHTML = Object.entries(estateData.reports.audit).map(([section, content]) => `<h4 class="font-semibold mt-2 text-gray-800">${section.replace(/([A-Z])/g, ' $1').trim()}:</h4><p class="text-sm text-gray-600">${content}</p>`).join('');
                }
            }

            function attachEventListeners() {
                container.querySelectorAll('.dropdown-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const id = event.currentTarget.dataset.dropdownId;
                        const content = document.getElementById(id);
                        const isActive = content.classList.toggle('active');
                        event.currentTarget.classList.toggle('active', isActive);
                    });
                });
                container.querySelector('.policy-modal-btn')?.addEventListener('click', () => openPolicyModal(estateData));
            }

            renderEstate();
        });
        
        function openPolicyModal(estate) {
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            modalTitle.innerText = `Agricultural Policy Cross-Reference: ${estate.name}`;
            modalContent.innerHTML = estate.policy;
            document.getElementById('policyModal').classList.add('active');
        }

        function closePolicyModal() {
            document.getElementById('policyModal').classList.remove('active');
        }
    </script>
</body>
</html>
